<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Commande {{ order.seller_name }} - Mutual Order</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .mutual-header {
      background-color: #0d6efd;
      padding: 0.75rem 0;
      margin-bottom: 2rem;
    }
    .yellow-section-header {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin: 2rem 0 1rem 0;
      font-weight: bold;
    }
    .rounded-button {
      border-radius: 25px;
      padding: 0.5rem 1rem;
      border: 1px solid #dee2e6;
      background: white;
      text-decoration: none;
      color: #495057;
      display: inline-block;
      transition: all 0.3s ease;
    }
    .rounded-button:hover {
      background: #f8f9fa;
      color: #495057;
      text-decoration: none;
    }
    .dotted-button {
      border: 2px dashed #6c757d;
      background: white;
      text-align: center;
    }
    .participant-creator {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 15px;
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      display: inline-block;
    }
    .participant-normal {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: 15px;
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      display: inline-block;
    }
    .info-box {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .my-order-box {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .right-panel-header {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 0.75rem;
    }
    .status-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 0.75rem 1rem;
    }
    .status-badge {
      font-weight: bold;
      font-size: 1em;
    }
    .share-button {
      background: #0d6efd;
      color: white;
      border: 1px solid #0d6efd;
      border-radius: 20px;
      padding: 0.5rem 1rem;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9em;
    }
    .share-button:hover {
      background: #0b5ed7;
      color: white;
      text-decoration: none;
    }
    .chat-button {
      background: #6f42c1;
      color: white;
      border: 2px solid #6f42c1;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-size: 1.3em;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }
    .chat-button:hover {
      background: #5a2d91;
      border-color: #5a2d91;
      color: white;
      text-decoration: none;
      transform: scale(1.05);
    }
    .chat-unread-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      font-weight: bold;
      border: 2px solid white;
    }
    .progress-steps {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .modern-progress {
      position: relative;
      margin: 1rem 0;
    }
    .progress-line {
      width: 100%;
      height: 4px;
      background-color: #e9ecef;
      border-radius: 2px;
      position: relative;
      margin: 1rem 0;
    }
    .progress-fill-modern {
      height: 100%;
      background: linear-gradient(90deg, #198754 0%, #20c997 100%);
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    .progress-steps-container {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 1rem;
      align-items: center;
    }
    .step-indicator {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9em;
      font-weight: bold;
      z-index: 2;
      position: relative;
      margin: 0 auto;
    }
    .step-completed-modern {
      background-color: #198754;
      color: white;
    }
    .step-active-modern {
      background-color: #0d6efd;
      color: white;
    }
    .step-pending-modern {
      background-color: #e9ecef;
      color: #6c757d;
    }
    .step-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
    }
    .step-label {
      font-size: 0.8em;
      text-align: center;
      color: #6c757d;
      flex: 1;
      line-height: 1.2;
      padding: 0 0.25rem;
    }
    .step-label.active {
      color: #0d6efd;
      font-weight: 600;
    }
    .step-label.completed {
      color: #198754;
      font-weight: 500;
    }
    .header-container {
      display: inline-block;
    }
    .smaller-button {
      font-size: 0.85em;
      padding: 0.4rem 0.8rem;
    }
    .condition-mint { background-color: #198754 !important; }
    .condition-nm { background-color: #20c997 !important; }
    .condition-vg-plus { background-color: #ffc107 !important; color: #000 !important; }
    .condition-vg { background-color: #fd7e14 !important; }
    .condition-good { background-color: #dc3545 !important; }
    .condition-fair { background-color: #6c757d !important; }
    .condition-poor { background-color: #343a40 !important; }
    .listing-table {
      background: white;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      overflow: hidden;
    }
    .add-listing-container {
      display: flex;
      gap: 1rem;
      align-items: stretch;
    }
    .add-listing-input {
      flex: 1;
      border-radius: 25px;
      border: 1px solid #dee2e6;
      padding: 0.75rem 1rem;
    }
    .add-listing-button {
      border-radius: 25px;
      background-color: #0d6efd;
      border: 1px solid #0d6efd;
      color: white;
      padding: 0.75rem 1.5rem;
      white-space: nowrap;
    }
    .validation-recap {
      background: #e3f2fd;
      border: 1px solid #1976d2;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .recap-table {
      background: white;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    .removed-discs-table {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    .chat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1050;
      display: none;
    }
    .chat-panel {
      position: fixed;
      right: 20px;
      top: 20px;
      bottom: 20px;
      width: 400px;
      background: white;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .chat-header {
      background: #0d6efd;
      color: white;
      padding: 1rem;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      max-height: 400px;
    }
    .chat-message {
      margin-bottom: 1rem;
      padding: 0.5rem;
      border-radius: 8px;
      max-width: 80%;
    }
    .chat-message.own {
      background: #e3f2fd;
      margin-left: auto;
      text-align: right;
    }
    .chat-message.other {
      background: #f5f5f5;
    }
    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      display: flex;
      gap: 0.5rem;
    }
    .chat-input {
      flex: 1;
      border: 1px solid #dee2e6;
      border-radius: 20px;
      padding: 0.5rem 1rem;
    }
    .chat-send {
      background: #0d6efd;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Mutual Order Header -->
  <div class="mutual-header">
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center">
        <a href="{{ url_for('index') }}" class="text-white text-decoration-none">
          <h4 class="mb-0">MUTUAL ORDER 0.3</h4>
        </a>
        <div class="d-flex align-items-center gap-3 text-white">
          <!-- Chat Button -->
          <button class="chat-button" onclick="toggleChat()" title="Discussion de la commande" id="chatButton">
            üí¨
            <span class="chat-unread-badge" id="unreadBadge" style="display: none;">0</span>
          </button>
          <span>{{ current_user.username }}</span>
          <a href="{{ url_for('logout') }}" class="btn btn-light btn-sm">D√©connexion</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'info' if category == 'info' else 'success' }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row">
      <!-- Main Content -->
      <div class="col-lg-8">
        
        <!-- First Row: Seller Info -->
        <div class="header-container">
          <div class="d-flex align-items-center gap-3 mb-4">
            <h2 class="mb-0"><strong>Commande chez {{ order.seller_name }}</strong></h2>
            {% if seller_info.rating %}
              <span class="fs-5">‚≠ê {{ "%.1f"|format(seller_info.rating) }}/5</span>
            {% endif %}
            {% if seller_info.location != 'Non sp√©cifi√©e' %}
              <span class="text-muted">üìç {{ seller_info.location }}</span>
            {% endif %}
            <a href="https://www.discogs.com/user/{{ order.seller_name }}" target="_blank" class="text-primary">üë§ Profile discogs</a>
            {% if order.seller_shop_url %}
              <a href="{{ order.seller_shop_url }}" target="_blank" class="text-success fs-5">üè™</a>
            {% endif %}
          </div>
        </div>

        <!-- Second Row: Stats and Actions -->
        <div class="d-flex justify-content-between align-items-start mb-4">
          <!-- Left Side Stats -->
          <div>
            <div class="d-flex align-items-center gap-4 mb-2">
              <span><strong>üíø {{ available_listings | length }} DISQUE{{ 's' if (available_listings | length) > 1 else '' }}</strong></span>
              <span>üë• {{ order.participants_count }} Participant{{ 's' if order.participants_count > 1 else '' }}</span>
              {% if order.deadline %}
                {% set current_date = now().date() %}
                {% set deadline_date = order.deadline.date() %}
                {% set days_left = (deadline_date - current_date).days %}
                <span>üïò <em>se termine dans</em> <strong>{{ days_left }}J</strong></span>
              {% endif %}
            </div>
            <div>
              <span>üì¶ Frais de port + Taxes: <strong>{{ "%.2f"|format(order.shipping_cost + order.taxes) }}‚Ç¨</strong></span>
              {% if available_listings | length > 0 %}
                <br><small class="fst-italic text-muted">Soit {{ "%.2f"|format((order.shipping_cost + order.taxes) / (available_listings | length)) }}‚Ç¨ le disque</small>
              {% endif %}
            </div>
          </div>

          <!-- Right Side Actions -->
          <div class="d-flex flex-column gap-2">
            <a href="https://www.discogs.com/seller/{{ order.seller_name }}/profile" 
               target="_blank" class="rounded-button">
               üéµ Voir les autres disques du vendeur
            </a>
            {% if order.direct_url %}
            <a href="{{ order.direct_url }}" 
               target="_blank" class="rounded-button" style="background: #28a745; color: white; border-color: #28a745;">
               üîó Commande directe chez le vendeur
            </a>
            {% endif %}
            {% if order.status == 'building' %}
            <a href="{{ url_for('verify_order_availability', order_id=order.id) }}" 
               class="rounded-button dotted-button smaller-button"
               onclick="return confirm('V√©rifier la disponibilit√© ?')">
               üîÑ V√©rifier la disponibilit√©
            </a>
            {% endif %}
          </div>
        </div>

        <!-- STEP 1: COMPOSITION -->
        {% if order.status == 'building' %}
          <!-- Add Listing Section (First) -->
          <div class="section-header-container">
            <div class="yellow-section-header">
              ‚ûï <strong>Ajouter un disque</strong>
            </div>
          </div>
          <form method="POST" action="{{ url_for('add_listing_to_order', order_id=order.id) }}">
            <div class="add-listing-container">
              <input type="url" name="listing_url" class="add-listing-input"
                     placeholder="Coller l'URL de l'annonce Discogs..." required>
              <button type="submit" class="add-listing-button">Ajouter √† la commande</button>
            </div>
          </form>

          <!-- My Discs Section (Second) -->
          {% set my_listings = available_listings|selectattr('user_id', 'equalto', current_user.id)|list %}
          {% if my_listings %}
          <div class="section-header-container">
            <div class="yellow-section-header">
              üíø <strong>Mes disques</strong>
            </div>
          </div>
          <div class="listing-table">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 80px;">Pochette</th>
                  <th style="width: 40%;">Titre</th>
                  <th style="width: 100px;">Prix</th>
                  <th style="width: 140px;">√âtat Vinyle</th>
                  <th style="width: 140px;">√âtat Pochette</th>
                  <th style="width: 120px;">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for listing in my_listings %}
                <tr>
                  <td>
                    {% if listing.image_url %}
                      <img src="{{ listing.image_url }}" alt="cover" style="width: 60px; height: 60px; object-fit: cover;" class="rounded">
                    {% else %}
                      <div style="width: 60px; height: 60px;" class="bg-light rounded d-flex align-items-center justify-content-center">
                        <small class="text-muted">?</small>
                      </div>
                    {% endif %}
                  </td>
                  <td>
                    <strong>{{ listing.title }}</strong><br>
                    <small class="text-muted">ID: {{ listing.discogs_id }}</small>
                  </td>
                  <td>{{ "%.2f"|format(listing.price_value) }}‚Ç¨</td>
                  <td>
                    {% set media_class = 'condition-mint' if 'Mint' in listing.media_condition else 'condition-nm' if 'Near Mint' in listing.media_condition else 'condition-vg-plus' if 'Very Good Plus' in listing.media_condition else 'condition-vg' if 'Very Good' in listing.media_condition else 'condition-good' if 'Good' in listing.media_condition else 'condition-fair' if 'Fair' in listing.media_condition else 'condition-poor' %}
                    <span class="badge {{ media_class }}">{{ listing.media_condition }}</span>
                  </td>
                  <td>
                    {% set sleeve_class = 'condition-mint' if 'Mint' in listing.sleeve_condition else 'condition-nm' if 'Near Mint' in listing.sleeve_condition else 'condition-vg-plus' if 'Very Good Plus' in listing.sleeve_condition else 'condition-vg' if 'Very Good' in listing.sleeve_condition else 'condition-good' if 'Good' in listing.sleeve_condition else 'condition-fair' if 'Fair' in listing.sleeve_condition else 'condition-poor' %}
                    <span class="badge {{ sleeve_class }}">{{ listing.sleeve_condition }}</span>
                  </td>
                  <td>
                    <div class="btn-group-vertical btn-group-sm">
                      <a href="{{ listing.listing_url }}" target="_blank" class="btn btn-outline-primary btn-sm">Voir sur Discogs</a>
                      <a href="{{ url_for('delete_listing', listing_id=listing.id) }}" 
                         class="btn btn-outline-danger btn-sm"
                         onclick="return confirm('Retirer ce disque ?');">Retirer de la commande</a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}

          <!-- Other Users' Discs Section (Always show if exists) -->
          {% set other_listings = available_listings|rejectattr('user_id', 'equalto', current_user.id)|list %}
          {% if other_listings %}
          <div class="section-header-container">
            <div class="yellow-section-header">
              üéµ <strong>Disques ajout√©s par les autres utilisateurs</strong>
            </div>
          </div>
          <div class="listing-table">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 80px;">Pochette</th>
                  <th style="width: 35%;">Titre</th>
                  <th style="width: 100px;">Prix</th>
                  <th style="width: 140px;">√âtat Vinyle</th>
                  <th style="width: 140px;">√âtat Pochette</th>
                  <th style="width: 120px;">Ajout√© par</th>
                  <th style="width: 80px;">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for listing in other_listings %}
                <tr>
                  <td>
                    {% if listing.image_url %}
                      <img src="{{ listing.image_url }}" alt="cover" style="width: 60px; height: 60px; object-fit: cover;" class="rounded">
                    {% else %}
                      <div style="width: 60px; height: 60px;" class="bg-light rounded d-flex align-items-center justify-content-center">
                        <small class="text-muted">?</small>
                      </div>
                    {% endif %}
                  </td>
                  <td>
                    <strong>{{ listing.title }}</strong><br>
                    <small class="text-muted">ID: {{ listing.discogs_id }}</small>
                  </td>
                  <td>{{ "%.2f"|format(listing.price_value) }}‚Ç¨</td>
                  <td>
                    {% set media_class = 'condition-mint' if 'Mint' in listing.media_condition else 'condition-nm' if 'Near Mint' in listing.media_condition else 'condition-vg-plus' if 'Very Good Plus' in listing.media_condition else 'condition-vg' if 'Very Good' in listing.media_condition else 'condition-good' if 'Good' in listing.media_condition else 'condition-fair' if 'Fair' in listing.media_condition else 'condition-poor' %}
                    <span class="badge {{ media_class }}">{{ listing.media_condition }}</span>
                  </td>
                  <td>
                    {% set sleeve_class = 'condition-mint' if 'Mint' in listing.sleeve_condition else 'condition-nm' if 'Near Mint' in listing.sleeve_condition else 'condition-vg-plus' if 'Very Good Plus' in listing.sleeve_condition else 'condition-vg' if 'Very Good' in listing.sleeve_condition else 'condition-good' if 'Good' in listing.sleeve_condition else 'condition-fair' if 'Fair' in listing.sleeve_condition else 'condition-poor' %}
                    <span class="badge {{ sleeve_class }}">{{ listing.sleeve_condition }}</span>
                  </td>
                  <td>
                    <strong>{{ listing.user.username }}</strong>
                    {% if listing.user_id == order.creator_id %}<br><small class="text-warning">üëë Cr√©ateur</small>{% endif %}
                  </td>
                  <td>
                    <a href="{{ listing.listing_url }}" target="_blank" class="btn btn-outline-primary btn-sm">Voir sur Discogs</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}

          <!-- Creator Recap Table (For creators only) -->
          {% if (order.creator_id == current_user.id or current_user.is_admin) %}
          <div class="section-header-container">
            <div class="yellow-section-header">
              üìä <strong>R√©capitulatif par participant</strong>
            </div>
          </div>
          <div class="recap-table">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Participant</th>
                  <th>Nombre de disques</th>
                  <th>Montant disques</th>
                  <th>Part frais/taxes</th>
                  <th>Total √† payer</th>
                </tr>
              </thead>
              <tbody>
                {% for participant in order.participants %}
                  {% set participant_listings = available_listings|selectattr('user_id', 'equalto', participant.id)|list %}
                  {% set participant_total = participant_listings | map(attribute='price_value') | sum %}
                  {% set participant_count = participant_listings|length %}
                  {% set total_items = available_listings | length %}
                  {% set participant_shipping_share = (order.shipping_cost * participant_count / total_items) if total_items > 0 else 0 %}
                  {% set participant_tax_share = (order.taxes * participant_count / total_items) if total_items > 0 else 0 %}
                  {% set participant_fees_share = participant_shipping_share + participant_tax_share %}
                  {% set participant_final_total = participant_total + participant_fees_share %}
                  <tr {% if participant.id == order.creator_id %}class="table-warning"{% endif %}>
                    <td>
                      <strong>{{ participant.username }}</strong>
                      {% if participant.id == order.creator_id %}<span class="badge bg-warning text-dark ms-1">üëë Cr√©ateur</span>{% endif %}
                    </td>
                    <td>{{ participant_count }}</td>
                    <td>{{ "%.2f"|format(participant_total) }}‚Ç¨</td>
                    <td>{{ "%.2f"|format(participant_fees_share) }}‚Ç¨</td>
                    <td><strong>{{ "%.2f"|format(participant_final_total) }}‚Ç¨</strong></td>
                  </tr>
                {% endfor %}
                <tr class="table-secondary">
                  <td><strong>TOTAL</strong></td>
                  <td><strong>{{ available_listings | length }}</strong></td>
                  <td><strong>{{ "%.2f"|format(order.total_price) }}‚Ç¨</strong></td>
                  <td><strong>{{ "%.2f"|format(order.shipping_cost + order.taxes) }}‚Ç¨</strong></td>
                  <td><strong>{{ "%.2f"|format(order.total_with_fees) }}‚Ç¨</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
          {% endif %}

        <!-- STEP 2: VALIDATION -->
        {% elif order.status == 'validation' %}
          <!-- Creator Recap Table (For creators only) -->
          {% if (order.creator_id == current_user.id or current_user.is_admin) %}
          <div class="section-header-container">
            <div class="yellow-section-header">
              üìä <strong>R√©capitulatif des validations</strong>
            </div>
          </div>
          <div class="recap-table">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Participant</th>
                  <th>Nombre de disques</th>
                  <th>Total √† payer</th>
                  <th>Statut validation</th>
                </tr>
              </thead>
              <tbody>
                {% for participant in order.participants %}
                  {% set participant_listings = available_listings|selectattr('user_id', 'equalto', participant.id)|list %}
                  {% set participant_total = participant_listings | map(attribute='price_value') | sum %}
                  {% set participant_count = participant_listings|length %}
                  {% set total_items = available_listings | length %}
                  {% set participant_shipping_share = (order.shipping_cost * participant_count / total_items) if total_items > 0 else 0 %}
                  {% set participant_tax_share = (order.taxes * participant_count / total_items) if total_items > 0 else 0 %}
                  {% set participant_fees_share = participant_shipping_share + participant_tax_share %}
                  {% set participant_final_total = participant_total + participant_fees_share %}
                  {% set validation = order.validations|selectattr('user_id', 'equalto', participant.id)|first %}
                  <tr {% if participant.id == order.creator_id %}class="table-warning"{% endif %}>
                    <td>
                      <strong>{{ participant.username }}</strong>
                      {% if participant.id == order.creator_id %}<span class="badge bg-warning text-dark ms-1">üëë Cr√©ateur</span>{% endif %}
                    </td>
                    <td>{{ participant_count }}</td>
                    <td><strong>{{ "%.2f"|format(participant_final_total) }}‚Ç¨</strong></td>
                    <td>
                      {% if participant.id == order.creator_id %}
                        <span class="badge bg-info">üëë Cr√©ateur (auto-valid√©)</span>
                      {% elif validation and validation.validated %}
                        <span class="badge bg-success">‚úÖ Valid√©</span>
                      {% else %}
                        <span class="badge bg-warning">‚è≥ En attente</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                <tr class="table-secondary">
                  <td><strong>TOTAL</strong></td>
                  <td><strong>{{ available_listings | length }}</strong></td>
                  <td><strong>{{ "%.2f"|format(order.total_with_fees) }}‚Ç¨</strong></td>
                  <td>
                    {% set validated_count = order.validations|selectattr('validated', 'equalto', true)|list|length + 1 %}
                    {% set total_participants = order.participants_count %}
                    <strong>{{ validated_count }}/{{ total_participants }} valid√©(s)</strong>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          {% endif %}

          <!-- Individual User Validation Recap -->
          {% if current_user in order.participants and order.creator_id != current_user.id %}
            {% set my_listings = available_listings|selectattr('user_id', 'equalto', current_user.id)|list %}
            {% set my_total = my_listings | map(attribute='price_value') | sum %}
            {% set my_count = my_listings|length %}
            {% set total_items = available_listings | length %}
            {% set my_shipping_share = (order.shipping_cost * my_count / total_items) if total_items > 0 else 0 %}
            {% set my_tax_share = (order.taxes * my_count / total_items) if total_items > 0 else 0 %}
            {% set my_fees_share = my_shipping_share + my_tax_share %}
            {% set my_final_total = my_total + my_fees_share %}
            
            <div class="section-header-container">
              <div class="yellow-section-header">
                ‚ö° <strong>Validation de votre commande</strong>
              </div>
            </div>
            
            <div class="validation-recap">
              <h6 class="mb-3">R√©capitulatif de votre commande:</h6>
              
              <!-- Individual disc breakdown -->
              <table class="table table-sm mb-3">
                <thead class="table-light">
                  <tr>
                    <th>Disque</th>
                    <th>Prix unitaire</th>
                  </tr>
                </thead>
                <tbody>
                  {% for listing in my_listings %}
                  <tr>
                    <td>{{ listing.title }}</td>
                    <td>{{ "%.2f"|format(listing.price_value) }}‚Ç¨</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              
              <!-- Summary -->
              <div class="mb-2"><strong>Nombre de disques:</strong> {{ my_count }}</div>
              <div class="mb-2"><strong>Sous-total disques:</strong> {{ "%.2f"|format(my_total) }}‚Ç¨</div>
              <div class="mb-2"><strong>Frais de port (votre part):</strong> {{ "%.2f"|format(my_shipping_share) }}‚Ç¨</div>
              <div class="mb-2"><strong>Taxes (votre part):</strong> {{ "%.2f"|format(my_tax_share) }}‚Ç¨</div>
              <hr>
              <div class="mb-2"><strong>TOTAL √Ä PAYER:</strong> {{ "%.2f"|format(my_final_total) }}‚Ç¨</div>
              <div class="mb-3"><strong>Moment du paiement:</strong> {{ order.payment_timing }}</div>
              
              {% set user_validation = order.validations|selectattr('user_id', 'equalto', current_user.id)|first %}
              {% if not user_validation or not user_validation.validated %}
                <form method="POST" action="{{ url_for('user_validate_order', order_id=order.id) }}">
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="agreeCheckbox" required>
                    <label class="form-check-label" for="agreeCheckbox">
                      Je suis d'accord avec le tableau r√©capitulatif ci-dessus
                    </label>
                  </div>
                  <button type="submit" class="btn btn-primary w-100">
                    ‚úÖ Je valide ma participation
                  </button>
                </form>
              {% else %}
                <div class="alert alert-success mb-0">
                  ‚úÖ Vous avez valid√© votre participation
                </div>
              {% endif %}
            </div>
          {% endif %}
          
          <!-- Removed discs from non-validated users (if any) -->
          {% if removed_listings %}
          <div class="section-header-container">
            <div class="yellow-section-header">
              ‚ö†Ô∏è <strong>Disques retir√©s de la commande</strong>
            </div>
          </div>
          <div class="removed-discs-table">
            <table class="table table-warning mb-0">
              <thead class="table-warning">
                <tr>
                  <th>Titre</th>
                  <th>Prix</th>
                  <th>Participant</th>
                  <th>Raison</th>
                </tr>
              </thead>
              <tbody>
                {% for listing in removed_listings %}
                <tr>
                  <td>{{ listing.title }}</td>
                  <td>{{ "%.2f"|format(listing.price_value) }}‚Ç¨</td>
                  <td>{{ listing.user.username }}</td>
                  <td>N'a pas valid√© sa participation</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}

        <!-- STEPS 3+: ORDERING AND BEYOND -->
        {% else %}
          <!-- My Discs Section -->
          {% set my_listings = available_listings|selectattr('user_id', 'equalto', current_user.id)|list %}
          {% if my_listings %}
          <div class="section-header-container">
            <div class="yellow-section-header">
              üíø <strong>Mes disques</strong>
            </div>
          </div>
          <div class="listing-table">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 80px;">Pochette</th>
                  <th style="width: 40%;">Titre</th>
                  <th style="width: 100px;">Prix</th>
                  <th style="width: 140px;">√âtat Vinyle</th>
                  <th style="width: 140px;">√âtat Pochette</th>
                  <th style="width: 120px;">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for listing in my_listings %}
                <tr>
                  <td>
                    {% if listing.image_url %}
                      <img src="{{ listing.image_url }}" alt="cover" style="width: 60px; height: 60px; object-fit: cover;" class="rounded">
                    {% else %}
                      <div style="width: 60px; height: 60px;" class="bg-light rounded d-flex align-items-center justify-content-center">
                        <small class="text-muted">?</small>
                      </div>
                    {% endif %}
                  </td>
                  <td>
                    <strong>{{ listing.title }}</strong><br>
                    <small class="text-muted">ID: {{ listing.discogs_id }}</small>
                  </td>
                  <td>{{ "%.2f"|format(listing.price_value) }}‚Ç¨</td>
                  <td>
                    {% set media_class = 'condition-mint' if 'Mint' in listing.media_condition else 'condition-nm' if 'Near Mint' in listing.media_condition else 'condition-vg-plus' if 'Very Good Plus' in listing.media_condition else 'condition-vg' if 'Very Good' in listing.media_condition else 'condition-good' if 'Good' in listing.media_condition else 'condition-fair' if 'Fair' in listing.media_condition else 'condition-poor' %}
                    <span class="badge {{ media_class }}">{{ listing.media_condition }}</span>
                  </td>
                  <td>
                    {% set sleeve_class = 'condition-mint' if 'Mint' in listing.sleeve_condition else 'condition-nm' if 'Near Mint' in listing.sleeve_condition else 'condition-vg-plus' if 'Very Good Plus' in listing.sleeve_condition else 'condition-vg' if 'Very Good' in listing.sleeve_condition else 'condition-good' if 'Good' in listing.sleeve_condition else 'condition-fair' if 'Fair' in listing.sleeve_condition else 'condition-poor' %}
                    <span class="badge {{ sleeve_class }}">{{ listing.sleeve_condition }}</span>
                  </td>
                  <td>
                    <a href="{{ listing.listing_url }}" target="_blank" class="btn btn-outline-primary btn-sm">Voir sur Discogs</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}

          <!-- Other Discs Section (Always show if exists) -->
          {% set other_listings = available_listings|rejectattr('user_id', 'equalto', current_user.id)|list %}
          {% if other_listings %}
          <div class="section-header-container">
            <div class="yellow-section-header">
              üéµ <strong>Disques ajout√©s par les autres utilisateurs</strong>
            </div>
          </div>
          <div class="listing-table">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 80px;">Pochette</th>
                  <th style="width: 35%;">Titre</th>
                  <th style="width: 100px;">Prix</th>
                  <th style="width: 140px;">√âtat Vinyle</th>
                  <th style="width: 140px;">√âtat Pochette</th>
                  <th style="width: 120px;">Ajout√© par</th>
                  <th style="width: 80px;">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for listing in other_listings %}
                <tr>
                  <td>
                    {% if listing.image_url %}
                      <img src="{{ listing.image_url }}" alt="cover" style="width: 60px; height: 60px; object-fit: cover;" class="rounded">
                    {% else %}
                      <div style="width: 60px; height: 60px;" class="bg-light rounded d-flex align-items-center justify-content-center">
                        <small class="text-muted">?</small>
                      </div>
                    {% endif %}
                  </td>
                  <td>
                    <strong>{{ listing.title }}</strong><br>
                    <small class="text-muted">ID: {{ listing.discogs_id }}</small>
                  </td>
                  <td>{{ "%.2f"|format(listing.price_value) }}‚Ç¨</td>
                  <td>
                    {% set media_class = 'condition-mint' if 'Mint' in listing.media_condition else 'condition-nm' if 'Near Mint' in listing.media_condition else 'condition-vg-plus' if 'Very Good Plus' in listing.media_condition else 'condition-vg' if 'Very Good' in listing.media_condition else 'condition-good' if 'Good' in listing.media_condition else 'condition-fair' if 'Fair' in listing.media_condition else 'condition-poor' %}
                    <span class="badge {{ media_class }}">{{ listing.media_condition }}</span>
                  </td>
                  <td>
                    {% set sleeve_class = 'condition-mint' if 'Mint' in listing.sleeve_condition else 'condition-nm' if 'Near Mint' in listing.sleeve_condition else 'condition-vg-plus' if 'Very Good Plus' in listing.sleeve_condition else 'condition-vg' if 'Very Good' in listing.sleeve_condition else 'condition-good' if 'Good' in listing.sleeve_condition else 'condition-fair' if 'Fair' in listing.sleeve_condition else 'condition-poor' %}
                    <span class="badge {{ sleeve_class }}">{{ listing.sleeve_condition }}</span>
                  </td>
                  <td>
                    <strong>{{ listing.user.username }}</strong>
                    {% if listing.user_id == order.creator_id %}<br><small class="text-warning">üëë Cr√©ateur</small>{% endif %}
                  </td>
                  <td>
                    <a href="{{ listing.listing_url }}" target="_blank" class="btn btn-outline-primary btn-sm">Voir sur Discogs</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        {% endif %}

      </div>

      <!-- Right Panel -->
      <div class="col-lg-4">
        
        <!-- Status and Share -->
        <div class="status-container">
          <div>
            <div class="status-badge">
              {% set status_info = {
                'building': {'emoji': '‚õèÔ∏è', 'text': 'COMPOSITION COMMANDE'},
                'validation': {'emoji': '‚è≥', 'text': 'VALIDATION DE LA COMMANDE'}, 
                'ordered': {'emoji': '‚úÖ', 'text': 'COMMANDE PASS√âE SUR DISCOGS'},
                'delivered': {'emoji': 'üíø', 'text': 'COMMANDE LIVR√âE'},
                'closed': {'emoji': 'üéÅ', 'text': 'DISQUES DISTRIBU√âS'}
              } %}
              {{ status_info[order.status].emoji }} {{ status_info[order.status].text }}
            </div>
            <div class="text-muted mt-1" style="font-size: 0.85em;">
              {% if order.status == 'building' %}
                Depuis le {{ utc_to_paris(order.created_at).strftime('%d/%m/%Y √† %H:%M') }}
              {% elif order.status_changed_at %}
                Depuis le {{ utc_to_paris(order.status_changed_at).strftime('%d/%m/%Y √† %H:%M') }}
              {% else %}
                {{ utc_to_paris(order.created_at).strftime('%d/%m/%Y √† %H:%M') }}
              {% endif %}
            </div>
          </div>
          <button class="share-button" onclick="shareOrder()">Partager la commande</button>
        </div>

        <!-- Completion Bar -->
        <div class="progress-steps">
          {% set steps = [
            {'key': 'building', 'label': 'Composition commande', 'emoji': '‚õèÔ∏è'},
            {'key': 'validation', 'label': 'Validation de la commande', 'emoji': '‚è≥'},
            {'key': 'ordered', 'label': 'Commande pass√©e sur Discogs', 'emoji': '‚úÖ'},
            {'key': 'delivered', 'label': 'Commande livr√©e', 'emoji': 'üíø'},
            {'key': 'closed', 'label': 'Disques distribu√©s', 'emoji': 'üéÅ'}
          ] %}
          
          {% set status_order = ['building', 'validation', 'ordered', 'delivered', 'closed'] %}
          {% set current_index = status_order.index(order.status) %}
          {% set progress_percent = (current_index / (status_order|length - 1)) * 100 %}
          
          <div class="modern-progress">
            <div class="progress-steps-container">
              {% for step in steps %}
                {% set step_index = status_order.index(step.key) %}
                <div class="step-indicator 
                  {% if step_index < current_index %}step-completed-modern
                  {% elif step_index == current_index %}step-active-modern
                  {% else %}step-pending-modern{% endif %}">
                  {% if step_index < current_index %}‚úì
                  {% elif step_index == current_index %}{{ loop.index }}
                  {% else %}{{ loop.index }}{% endif %}
                </div>
              {% endfor %}
            </div>
            
            <div class="progress-line">
              <div class="progress-fill-modern" style="width: {{ progress_percent }}%;"></div>
            </div>
            
            <div class="step-labels">
              {% for step in steps %}
                {% set step_index = status_order.index(step.key) %}
                <div class="step-label 
                  {% if step_index < current_index %}completed
                  {% elif step_index == current_index %}active{% endif %}">
                  {{ step.emoji }}<br>{{ step.label }}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Workflow Actions (Creator Only) -->
        {% if (order.creator_id == current_user.id or current_user.is_admin) %}
          {% if order.status == 'building' %}
            <div class="info-box">
              <form method="POST" action="{{ url_for('validate_order', order_id=order.id) }}">
                <button type="submit" class="btn btn-success w-100"
                        onclick="return confirm('Valider cette commande ?')">
                  Passer √† l'√©tape suivante: ‚è≥ Validation de la commande
                </button>
              </form>
            </div>
          {% elif order.status == 'validation' %}
            <div class="info-box">
              <form method="POST" action="{{ url_for('change_order_status', order_id=order.id, new_status='ordered') }}">
                <button type="submit" class="btn btn-info w-100"
                        onclick="return confirm('Marquer comme command√© ?')">
                  Passer √† l'√©tape suivante: ‚úÖ Commande pass√©e sur Discogs
                </button>
              </form>
            </div>
          {% elif order.status == 'ordered' %}
            <div class="info-box">
              <form method="POST" action="{{ url_for('change_order_status', order_id=order.id, new_status='delivered') }}">
                <button type="submit" class="btn btn-success w-100"
                        onclick="return confirm('Marquer comme livr√© ?')">
                  Passer √† l'√©tape suivante: üíø Commande livr√©e
                </button>
              </form>
            </div>
          {% elif order.status == 'delivered' %}
            <div class="info-box">
              <form method="POST" action="{{ url_for('change_order_status', order_id=order.id, new_status='closed') }}">
                <button type="submit" class="btn btn-dark w-100"
                        onclick="return confirm('Fermer d√©finitivement ?')">
                  Passer √† l'√©tape suivante: üéÅ Disques distribu√©s
                </button>
              </form>
            </div>
          {% endif %}
        {% endif %}
        
        <!-- Participants -->
        <div class="info-box">
          <div class="right-panel-header">Participant{{ 's' if order.participants_count > 1 else '' }} ({{ order.participants_count }})</div>
          <div>
            <!-- Creator first, highlighted in yellow -->
            <span class="participant-creator">
              {{ order.creator.username }} üëë
            </span>
            <!-- Other participants in blue -->
            {% for participant in order.participants %}
              {% if participant.id != order.creator_id %}
                <span class="participant-normal">
                  {{ participant.username }}
                </span>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <!-- Order Info -->
        <div class="info-box">
          <div class="d-flex justify-content-between align-items-center">
            <div class="right-panel-header">Commande cr√©√©e par {{ order.creator.username }}</div>
            {% if order.user_location %}
              <div class="d-flex align-items-center gap-2">
                <span>üè† {{ order.user_location }}</span>
              </div>
            {% endif %}
          </div>
          <div class="mt-1">
            <strong>R√®gle de paiement:</strong> {{ order.payment_timing }}
          </div>
        </div>

        <!-- Validation Status for validation phase -->
        {% if order.status == 'validation' %}
          <div class="info-box">
            <div class="right-panel-header">√âtat des validations</div>
            {% for participant in order.participants %}
              {% set validation = order.validations|selectattr('user_id', 'equalto', participant.id)|first %}
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span>{{ participant.username }}</span>
                {% if validation and validation.validated %}
                  <span class="badge bg-success">‚úì Valid√©</span>
                {% else %}
                  <span class="badge bg-secondary">‚è≥ En attente</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- My Order Summary -->
        {% set my_listings = available_listings|selectattr('user_id', 'equalto', current_user.id)|list %}
        {% set my_total = my_listings | map(attribute='price_value') | sum %}
        {% set my_count = my_listings|length %}
        {% set total_items = available_listings | length %}
        {% set my_shipping_share = (order.shipping_cost * my_count / total_items) if total_items > 0 else 0 %}
        {% set my_tax_share = (order.taxes * my_count / total_items) if total_items > 0 else 0 %}
        {% set my_fees_share = my_shipping_share + my_tax_share %}
        {% set my_final_total = my_total + my_fees_share %}
        
        <div class="my-order-box">
          <div class="right-panel-header">Ma commande</div>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Nombre de disque{{ 's' if my_count > 1 else '' }}</span>
            <span><strong>{{ my_count }}</strong></span>
          </div>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Montant</span>
            <span><strong>{{ "%.2f"|format(my_total) }}‚Ç¨</strong></span>
          </div>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Ma part Frais & Taxes</span>
            <span><strong>{{ "%.2f"|format(my_fees_share) }}‚Ç¨</strong></span>
          </div>
          
          {% if my_count > 0 %}
          <div class="text-end mb-2">
            <small class="text-muted fst-italic">(Soit {{ "%.2f"|format(my_fees_share / my_count) }}‚Ç¨ de frais par disque)</small>
          </div>
          {% endif %}
          
          <hr>
          <div class="d-flex justify-content-between">
            <span><strong>Total</strong></span>
            <span><strong>{{ "%.2f"|format(my_final_total) }}‚Ç¨</strong></span>
          </div>
        </div>

        <!-- Administration Section -->
        {% if (order.creator_id == current_user.id or current_user.is_admin) %}
        <div class="info-box">
          <div class="right-panel-header">Administration Commande</div>
          
          <!-- Order Overview -->
          <div class="mb-3 p-2 bg-light rounded">
            <div class="d-flex justify-content-between small mb-1">
              <span>Disques:</span>
              <strong>{{ available_listings | length }}</strong>
            </div>
            <div class="d-flex justify-content-between small mb-1">
              <span>Participants:</span>
              <strong>{{ order.participants_count }}</strong>
            </div>
            <div class="d-flex justify-content-between small">
              <span>Total actuel:</span>
              <strong>{{ "%.2f"|format(order.total_with_fees) }}‚Ç¨</strong>
            </div>
          </div>
          
          <!-- Combined Order Settings and Fees -->
          <form method="POST" action="{{ url_for('update_order_settings', order_id=order.id) }}">
            <div class="mb-2">
              <label class="form-label small">URL directe de la commande</label>
              <input type="url" class="form-control form-control-sm" name="direct_url" 
                     placeholder="https://..." value="{{ order.direct_url or '' }}">
              <div class="form-text">Lien direct vers la page de commande chez le vendeur</div>
            </div>
            <div class="mb-2">
              <label class="form-label small">Montant maximum (‚Ç¨)</label>
              <input type="number" class="form-control form-control-sm" name="max_amount" 
                     step="0.01" min="0" value="{{ order.max_amount or '' }}">
            </div>
            <div class="mb-2">
              <label class="form-label small">Date limite</label>
              <input type="date" class="form-control form-control-sm" name="deadline" 
                     value="{{ order.deadline.strftime('%Y-%m-%d') if order.deadline else '' }}">
            </div>
            <div class="mb-2">
              <label class="form-label small">R√®gle de paiement</label>
              <select class="form-select form-select-sm" name="payment_timing">
                <option value="avant la commande" {{ 'selected' if order.payment_timing == 'avant la commande' else '' }}>Avant la commande</option>
                <option value="√† la remise des disques" {{ 'selected' if order.payment_timing == '√† la remise des disques' else '' }}>√Ä la remise des disques</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label small">Frais de port (‚Ç¨)</label>
              <input type="number" class="form-control form-control-sm" name="shipping_cost" 
                     step="0.01" min="0" value="{{ order.shipping_cost }}">
            </div>
            <div class="mb-3">
              <label class="form-label small">Taxes (‚Ç¨)</label>
              <input type="number" class="form-control form-control-sm" name="taxes" 
                     step="0.01" min="0" value="{{ order.taxes }}">
            </div>
            <button type="submit" class="btn btn-primary btn-sm w-100 mb-2">Mettre √† jour</button>
          </form>
          
          <!-- Delete Order Button -->
          <a href="{{ url_for('delete_order', order_id=order.id) }}" 
             class="btn btn-danger btn-sm w-100"
             onclick="return confirm('ATTENTION: Supprimer d√©finitivement cette commande et tous ses disques ? Cette action est irr√©versible.')">
             üóëÔ∏è Supprimer la commande
          </a>
        </div>
        {% endif %}

      </div>
    </div>
  </div>
  
  <!-- Chat Overlay and Panel -->
  <div class="chat-overlay" id="chatOverlay" onclick="toggleChat()">
    <div class="chat-panel" onclick="event.stopPropagation()">
      <div class="chat-header">
        <div>
          <h6 class="mb-0">üí¨ Discussion</h6>
          <small>Commande {{ order.seller_name }}</small>
        </div>
        <button class="btn btn-sm text-white" onclick="toggleChat()">‚úï</button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <!-- Messages will be loaded here -->
      </div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="Votre message..." maxlength="500">
        <button class="chat-send" onclick="sendMessage()">üì§</button>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let lastMessageCount = 0;
    let chatIsOpen = false;

    function shareOrder() {
      const url = window.location.href;
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(function() {
          alert('Lien copi√© dans le presse-papiers !');
        });
      } else {
        const textArea = document.createElement("textarea");
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Lien copi√© dans le presse-papiers !');
      }
    }

    function toggleChat() {
      const overlay = document.getElementById('chatOverlay');
      if (overlay.style.display === 'block') {
        overlay.style.display = 'none';
        chatIsOpen = false;
      } else {
        overlay.style.display = 'block';
        chatIsOpen = true;
        loadMessages();
        markMessagesAsRead();
      }
    }

    function loadMessages() {
      fetch(`/order/{{ order.id }}/chat/messages`)
        .then(response => response.json())
        .then(messages => {
          const messagesContainer = document.getElementById('chatMessages');
          messagesContainer.innerHTML = '';
          messages.forEach(message => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${message.is_own ? 'own' : 'other'}`;
            messageDiv.innerHTML = `
              <div class="mb-1"><strong>${message.username}</strong> <small class="text-muted">${message.timestamp}</small></div>
              <div>${escapeHtml(message.content)}</div>
            `;
            messagesContainer.appendChild(messageDiv);
          });
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          
          // Update last message count
          lastMessageCount = messages.length;
        })
        .catch(error => console.error('Error loading messages:', error));
    }

    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;

      fetch(`/order/{{ order.id }}/chat/send`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          input.value = '';
          loadMessages();
        } else {
          alert('Erreur lors de l\'envoi du message: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error sending message:', error);
        alert('Erreur lors de l\'envoi du message');
      });
    }

    function checkNewMessages() {
      if (chatIsOpen) {
        // If chat is open, just refresh messages
        loadMessages();
        return;
      }

      fetch(`/order/{{ order.id }}/chat/unread`)
        .then(response => response.json())
        .then(data => {
          const unreadBadge = document.getElementById('unreadBadge');
          if (data.unread_count > 0) {
            unreadBadge.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
            unreadBadge.style.display = 'flex';
          } else {
            unreadBadge.style.display = 'none';
          }
        })
        .catch(error => console.error('Error checking unread messages:', error));
    }

    function markMessagesAsRead() {
      fetch(`/order/{{ order.id }}/chat/mark_read`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const unreadBadge = document.getElementById('unreadBadge');
          unreadBadge.style.display = 'none';
        }
      })
      .catch(error => console.error('Error marking messages as read:', error));
    }

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // Allow Enter key to send message
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Check for new messages every 30 seconds
    setInterval(checkNewMessages, 30000);

    // Initial check for unread messages
    checkNewMessages();
  </script>
</body>
</html>
