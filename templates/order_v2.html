<!-- templates/order_v2.html -->
{% extends "base.html" %}

{% block title %}Commande {{ order.seller_name }} - MUTUAL ORDER{% endblock %}

{% block head %}
    <script>
        // Pass user data to JavaScript
        window.currentUserId = {{ current_user.id }};
        window.isAdmin = {{ 'true' if current_user.is_admin else 'false' }};
    </script>
{% endblock %}

{% block content %}
<!-- Single Alpine.js component for entire page -->
<div x-data="orderApp()" x-init="init()" class="min-h-screen">
    <!-- Loading State -->
    <div x-show="loading" x-cloak class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <!-- Main Content -->
    <div x-show="!loading" x-cloak class="max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
            
            <!-- Main Content Area - 2/3 width -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Order Info Component -->
                <div x-data="orderInfoComponent()">
                    {% include 'components/order_v2/info_section.html' %}
                </div>
                
                <!-- Validation Phase Component -->
                <div x-show="order.status === 'validation'" x-data="validationComponent()">
                    {% include 'components/order_v2/validation_section.html' %}
                </div>
                
                <!-- Listings Component -->
                <div x-data="listingsComponent()">
                    {% include 'components/order_v2/listings_section.html' %}
                </div>
                
                <!-- Chat Component (embedded) -->
                <div x-show="['validation', 'ordered', 'delivered', 'closed'].includes(order.status)" 
                     x-data="chatComponent()">
                    {% include 'components/order_v2/chat_embedded.html' %}
                </div>
                
            </div>

            <!-- Sidebar Components -->
            <div class="space-y-6">
                
                <!-- Status Component -->
                <div x-data="statusComponent()">
                    {% include 'components/order_v2/status_section.html' %}
                </div>
                
                <!-- Participants Component -->
                <div x-data="participantsComponent()">
                    {% include 'components/order_v2/participants_section.html' %}
                </div>
                
                <!-- Summary Component -->
                <div x-data="summaryComponent()">
                    {% include 'components/order_v2/summary_section.html' %}
                </div>
                
                <!-- Admin Component -->
                <div x-show="order.creator_id === currentUserId || isAdmin" x-data="adminComponent()">
                    {% include 'components/order_v2/admin_section.html' %}
                </div>
                
            </div>
        </div>
    </div>

    <!-- Global Modals -->
    <div x-data="modalsComponent()">
        {% include 'components/order_v2/modals.html' %}
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/order-app-v2.js') }}"></script>
{% endblock %}