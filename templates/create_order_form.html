{% extends "base.html" %}

{% block title %}Cr√©er une commande - MUTUAL ORDER{% endblock %}

{% block content %}
<div x-data="createOrderApp()" class="min-h-screen">
    <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Cr√©er une nouvelle commande</h1>
                <p class="text-gray-600">Configurez votre commande group√©e</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-8">
                <form @submit.prevent="createOrder" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üéµ URL de la premi√®re annonce Discogs *
                        </label>
                        <input type="url" x-model="form.first_listing_url" required
                            placeholder="https://www.discogs.com/sell/item/123456789"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="mt-2 text-sm text-gray-600">
                            Cette annonce d√©terminera le vendeur pour toute la commande group√©e.
                        </p>
                    </div>


                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üìÖ Date pr√©vue de la r√©alisation de la commande *
                        </label>
                        <input type="date" x-model="form.deadline" required
                            :min="getTomorrowDate()"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="mt-2 text-sm text-gray-600">
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üí≥ Votre lien Paypal.me pour recevoir les paiements
                        </label>
                        <input type="url" x-model="form.paypal_link"
                            placeholder="https://paypal.me/votrenom"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="mt-2 text-sm text-gray-600">
                            Ce lien sera accessible pour tous les utilisateurs rejoignant la commande. 
                            <a href="https://www.paypal.com/signin?returnUri=https%3A%2F%2Fwww.paypal.com%2Fpaypalme&state=%2Fmy%2Flanding%3Fentry%3Dmarketing" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                Cr√©er votre lien PayPal.me
                            </a>
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üè† Ville de r√©cup√©ration - livraison des commandes *
                        </label>
                        <select x-model="form.city" 
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">S√©lectionnez une ville</option>
                            <option value="Paris">Paris</option>
                            <option value="Nantes">Nantes</option>
                            <option value="Dijon">Dijon</option>
                            <option value="Lyon">Lyon</option>
                            <option value="Marseille">Marseille</option>
                        </select>
                        <p class="mt-2 text-sm text-gray-600">
                            Ville o√π les participants pourront r√©cup√©rer leurs commandes.
                        </p>
                    </div>

                    <div x-show="form.city === 'Nantes' || false">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üìç M√©thode de distribution
                        </label>
                        <select x-model="form.distribution_method"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">S√©lectionnez une m√©thode</option>
                            <option x-show="form.city === 'Nantes'" value="Bar Safe Place">Bar Safe Place</option>
                            <option value="Autre">Autre</option>
                        </select>
                        <p class="mt-2 text-sm text-gray-600" x-show="form.city && form.city !== 'Nantes'">
                            Aucun point de retrait disponible pour cette ville.
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üè™ Lien boutique vendeur
                        </label>
                        <input type="url" x-model="form.seller_shop_url"
                               placeholder="Site web du vendeur"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="flex justify-between pt-6">
                        <a href="/" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Annuler
                        </a>
                        <button type="submit" :disabled="submitting"
                                class="px-8 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50">
                            <span x-show="!submitting">Cr√©er la commande</span>
                            <span x-show="submitting">Cr√©ation en cours...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
        function createOrderApp() {
            return {
                submitting: false,
                form: {
                    first_listing_url: '',
                    deadline: '',
                    paypal_link: '{{ user.default_paypal_link or "" }}',
                    city: '{{ user.city or "" }}',
                    distribution_method: '',
                    seller_shop_url: '',
                    payment_timing: 'avant la commande'
                },
                
                getTomorrowDate() {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return tomorrow.toISOString().split('T')[0];
                },
                
                async createOrder() {
                    if (this.submitting) return;
                    
                    this.submitting = true;
                    
                    try {
                        const formData = new FormData();
                        Object.keys(this.form).forEach(key => {
                            if (this.form[key]) {
                                formData.append(key, this.form[key]);
                            }
                        });
                        
                        const response = await fetch('/create_order_form', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.redirected) {
                            // If redirected, it means success - follow the redirect
                            window.location.href = response.url;
                        } else {
                            // Handle error case
                            const text = await response.text();
                            if (text.includes('alert-danger') || text.includes('alert-warning')) {
                                // Extract error message from HTML (basic approach)
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(text, 'text/html');
                                const alertEl = doc.querySelector('.alert');
                                const errorMessage = alertEl ? alertEl.textContent.trim() : 'Erreur lors de la cr√©ation';
                                window.addFlashMessage('danger', errorMessage);
                            } else {
                                window.addFlashMessage('danger', 'Erreur inattendue');
                            }
                        }
                    } catch (error) {
                        console.error('Error creating order:', error);
                        window.addFlashMessage('danger', 'Erreur de connexion');
                    } finally {
                        this.submitting = false;
                    }
                }
            }
        }
    </script>
{% endblock %}