{% extends "base.html" %}

{% block title %}Debug - Wantlist Matching{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">üîç Debug - Wantlist Matching</h1>
        <p class="text-gray-600">Test wantlist matching with available listings from open orders</p>
    </div>

    <div x-data="wantlistDebugApp()" x-init="init()" class="space-y-6">
        <!-- Loading State -->
        <div x-show="loading" class="flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>

        <!-- Error State -->
        <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Erreur</h3>
                    <div class="mt-2 text-sm text-red-700" x-text="error"></div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div x-show="!loading && !error && results" class="space-y-6">
            <!-- Summary -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">üìä R√©sum√©</h2>
                    <div class="space-x-2">
                        <button @click="refreshCache()" 
                                :disabled="refreshing"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                            <span x-show="!refreshing">üîÑ Actualiser le cache</span>
                            <span x-show="refreshing">‚è≥ Actualisation...</span>
                        </button>
                        <button @click="refreshCacheBypass()" 
                                :disabled="refreshing"
                                class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:opacity-50">
                            <span x-show="!refreshing">‚ö° Actualiser sans cache</span>
                            <span x-show="refreshing">‚è≥ Actualisation...</span>
                        </button>
                        <button @click="clearCache()" 
                                :disabled="clearing"
                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50">
                            <span x-show="!clearing">üóëÔ∏è Vider le cache</span>
                            <span x-show="clearing">‚è≥ Suppression...</span>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="text-2xl font-bold text-blue-600" x-text="results.wantlist_count || 0"></div>
                        <div class="text-sm text-blue-800">Articles dans la wantlist</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="text-2xl font-bold text-green-600" x-text="results.matches.length || 0"></div>
                        <div class="text-sm text-green-800">Commandes avec correspondances</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="text-2xl font-bold text-purple-600" x-text="totalMatches || 0"></div>
                        <div class="text-sm text-purple-800">Correspondances totales</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4">
                        <div class="text-2xl font-bold text-orange-600" x-text="cachedSellers || 0"></div>
                        <div class="text-sm text-orange-800">Vendeurs en cache</div>
                    </div>
                </div>
            </div>

            <!-- Background Jobs Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üïê T√¢ches en arri√®re-plan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-medium text-gray-900">Statut du planificateur</div>
                                <div class="text-sm text-gray-600" x-text="jobStatus.running ? 'üü¢ Actif' : 'üî¥ Inactif'"></div>
                            </div>
                            <button @click="loadJobStatus()" 
                                    class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded hover:bg-blue-200">
                                Actualiser
                            </button>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="font-medium text-gray-900">Derni√®re ex√©cution</div>
                        <div class="text-sm text-gray-600" x-text="lastJobRun || 'Jamais'"></div>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                        <div>
                            <div class="font-medium text-blue-900">Actualisation des inventaires</div>
                            <div class="text-sm text-blue-700">Tous les jours √† 02:00</div>
                        </div>
                        <button @click="triggerJob('seller_inventories')" 
                                class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                            D√©clencher
                        </button>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                        <div>
                            <div class="font-medium text-green-900">Actualisation des wantlists</div>
                            <div class="text-sm text-green-700">Tous les jours √† 03:00</div>
                        </div>
                        <button @click="triggerJob('user_wantlists')" 
                                class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                            D√©clencher
                        </button>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                        <div>
                            <div class="font-medium text-purple-900">Vendeurs actifs</div>
                            <div class="text-sm text-purple-700">Toutes les 6 heures</div>
                        </div>
                        <button @click="triggerJob('active_sellers')" 
                                class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                            D√©clencher
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cache Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üíæ √âtat du cache</h3>
                <div class="space-y-2">
                    <template x-for="seller in cacheStatus" :key="seller.seller_name">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 rounded-full" 
                                     :class="seller.is_cached ? 'bg-green-500' : 'bg-red-500'"></div>
                                <span class="font-medium" x-text="seller.seller_name"></span>
                                <span x-show="seller.metadata" class="text-sm text-gray-600">
                                    (<span x-text="seller.metadata.count"></span> articles)
                                </span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span x-show="seller.metadata?.is_large_seller" 
                                      class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">
                                    Grand vendeur
                                </span>
                                <button @click="refreshSeller(seller.seller_name)" 
                                        class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded hover:bg-blue-200">
                                    Actualiser
                                </button>
                                <button x-show="seller.seller_name === 'FactoryUdine'" 
                                        @click="refreshFactoryUdineComplete()" 
                                        class="px-3 py-1 bg-orange-100 text-orange-800 text-sm rounded hover:bg-orange-200"
                                        :disabled="refreshingFactoryUdine">
                                    <span x-show="!refreshingFactoryUdine">Liste compl√®te</span>
                                    <span x-show="refreshingFactoryUdine">Chargement...</span>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- FactoryUdine Debug Section -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üîç Debug FactoryUdine</h3>
                <div class="mb-4 flex space-x-3">
                    <button @click="loadFactoryUdineDebug()" 
                            class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700"
                            :disabled="loadingFactoryUdineDebug">
                        <span x-show="!loadingFactoryUdineDebug">Charger les donn√©es de debug</span>
                        <span x-show="loadingFactoryUdineDebug">Chargement...</span>
                    </button>
                    <button @click="clearFactoryUdineCache()" 
                            class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                            :disabled="clearingFactoryUdine">
                        <span x-show="!clearingFactoryUdine">Vider le cache FactoryUdine</span>
                        <span x-show="clearingFactoryUdine">Suppression...</span>
                    </button>
                </div>
                
                <div x-show="factoryUdineDebug" class="space-y-4">
                    <!-- Pagination Summary -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="text-md font-semibold text-blue-800 mb-2">üìä R√©sum√© de l'inventaire</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="font-medium text-blue-700">Cache actuel:</div>
                                <div class="text-blue-600" x-text="factoryUdineDebug.total_count"></div>
                            </div>
                            <div>
                                <div class="font-medium text-blue-700">Total Discogs:</div>
                                <div class="text-blue-600" x-text="factoryUdineDebug.pagination?.total_items"></div>
                            </div>
                            <div>
                                <div class="font-medium text-blue-700">Pages totales:</div>
                                <div class="text-blue-600" x-text="factoryUdineDebug.pagination?.total_pages"></div>
                            </div>
                            <div>
                                <div class="font-medium text-blue-700">Items manquants:</div>
                                <div class="text-red-600 font-semibold" 
                                     x-text="(factoryUdineDebug.pagination?.total_items || 0) - (factoryUdineDebug.total_count || 0)"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Status -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="text-md font-semibold text-green-800 mb-2">‚úÖ Statut</h4>
                        <div class="text-sm text-green-700">
                            <div x-show="(factoryUdineDebug.pagination?.total_items || 0) === (factoryUdineDebug.total_count || 0)">
                                üéâ Inventaire complet! Tous les items sont en cache.
                            </div>
                            <div x-show="(factoryUdineDebug.pagination?.total_items || 0) > (factoryUdineDebug.total_count || 0)">
                                ‚ö†Ô∏è <span x-text="(factoryUdineDebug.pagination?.total_items || 0) - (factoryUdineDebug.total_count || 0)"></span> items manquants. 
                                Cliquez sur "Liste compl√®te" pour les r√©cup√©rer.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Matches by Order -->
            <template x-for="orderMatch in results.matches" :key="orderMatch.order_id">
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900" x-text="orderMatch.order_title"></h3>
                                <p class="text-sm text-gray-600">Vendeur: <span x-text="orderMatch.seller_name"></span></p>
                                <p class="text-sm text-gray-600">Statut: <span x-text="orderMatch.order_status"></span></p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-green-600" x-text="orderMatch.total_matches"></div>
                                <div class="text-sm text-gray-600">correspondances</div>
                                <div class="text-xs text-gray-500" x-text="'sur ' + orderMatch.inventory_count + ' articles'"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="space-y-4">
                            <template x-for="match in orderMatch.matches" :key="match.listing_id">
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                    <div class="flex items-start space-x-4">
                                        <!-- Listing Image -->
                                        <div class="flex-shrink-0">
                                            <img x-show="match.wantlist_item.thumb" 
                                                 :src="match.wantlist_item.thumb" 
                                                 class="w-16 h-16 object-cover rounded"
                                                 alt="Release cover">
                                            <div x-show="!match.wantlist_item.thumb" 
                                                 class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center">
                                                <span class="text-gray-400">üéµ</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Match Details -->
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <h4 class="text-lg font-medium text-gray-900" x-text="match.listing_title"></h4>
                                                    <p class="text-sm text-gray-600">
                                                        <span x-text="match.wantlist_item.artists.join(', ')"></span>
                                                        <span x-show="match.wantlist_item.year"> - <span x-text="match.wantlist_item.year"></span></span>
                                                    </p>
                                                    <p class="text-sm text-gray-500" x-text="match.listing_condition"></p>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-lg font-semibold text-green-600">
                                                        <span x-text="match.listing_price"></span> <span x-text="match.listing_currency"></span>
                                                    </div>
                                                    <div class="text-xs text-gray-500" x-text="match.match_confidence"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- Wantlist Item Details -->
                                            <div class="mt-2 p-3 bg-blue-50 rounded">
                                                <div class="text-sm">
                                                    <span class="font-medium text-blue-800">Dans votre wantlist:</span>
                                                    <span class="text-blue-700" x-text="match.wantlist_item.title"></span>
                                                </div>
                                                <div x-show="match.wantlist_item.format" class="text-xs text-blue-600 mt-1">
                                                    Format: <span x-text="match.wantlist_item.format"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>

            <!-- No Matches -->
            <div x-show="results.matches.length === 0" class="text-center py-12">
                <div class="text-6xl mb-4">üéµ</div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Aucune correspondance trouv√©e</h3>
                <p class="text-gray-600">Aucun article de votre wantlist n'a √©t√© trouv√© dans les commandes ouvertes.</p>
            </div>
        </div>
    </div>
</div>

<script>
function wantlistDebugApp() {
    return {
        loading: true,
        error: null,
        results: null,
        cacheStatus: [],
        jobStatus: {},
        lastJobRun: null,
        refreshing: false,
        clearing: false,
        refreshingFactoryUdine: false,
        loadingFactoryUdineDebug: false,
        factoryUdineDebug: null,
        clearingFactoryUdine: false,
        
        get totalMatches() {
            if (!this.results || !this.results.matches) return 0;
            return this.results.matches.reduce((total, order) => total + order.total_matches, 0);
        },
        
        get cachedSellers() {
            return this.cacheStatus.filter(seller => seller.is_cached).length;
        },
        
        async init() {
            try {
                this.loading = true;
                this.error = null;
                
                // Load wantlist matches, cache status, and job status
                const [matchesResponse, cacheResponse, jobResponse] = await Promise.all([
                    fetch('/api/debug/wantlist-matches'),
                    fetch('/api/debug/cache-status'),
                    fetch('/api/debug/job-status')
                ]);
                
                const matchesData = await matchesResponse.json();
                const cacheData = await cacheResponse.json();
                const jobData = await jobResponse.json();
                
                if (!matchesResponse.ok) {
                    throw new Error(matchesData.error || 'Erreur lors du chargement des donn√©es');
                }
                
                this.results = matchesData;
                this.cacheStatus = cacheData.cache_status || [];
                this.jobStatus = jobData;
                
                // Format last job run time
                if (jobData.last_run && Object.keys(jobData.last_run).length > 0) {
                    const lastRun = Object.values(jobData.last_run).sort().pop();
                    this.lastJobRun = new Date(lastRun).toLocaleString('fr-FR');
                }
            } catch (error) {
                console.error('Error loading wantlist matches:', error);
                this.error = error.message;
            } finally {
                this.loading = false;
            }
        },
        
        async refreshCache() {
            try {
                this.refreshing = true;
                await this.init(); // Reload data
            } catch (error) {
                console.error('Error refreshing cache:', error);
                this.error = error.message;
            } finally {
                this.refreshing = false;
            }
        },
        
        async refreshCacheBypass() {
            try {
                this.refreshing = true;
                this.error = null;
                
                // Load wantlist matches with bypass_cache=true
                const matchesResponse = await fetch('/api/debug/wantlist-matches?bypass_cache=true');
                const matchesData = await matchesResponse.json();
                
                if (!matchesResponse.ok) {
                    throw new Error(matchesData.error || 'Erreur lors du chargement des donn√©es');
                }
                
                this.results = matchesData;
                
                // Also reload cache status and job status
                const [cacheResponse, jobResponse] = await Promise.all([
                    fetch('/api/debug/cache-status'),
                    fetch('/api/debug/job-status')
                ]);
                
                const cacheData = await cacheResponse.json();
                const jobData = await jobResponse.json();
                
                this.cacheStatus = cacheData.cache_status || [];
                this.jobStatus = jobData;
                
                // Format last job run time
                if (jobData.last_run && Object.keys(jobData.last_run).length > 0) {
                    const lastRun = Object.values(jobData.last_run).sort().pop();
                    this.lastJobRun = new Date(lastRun).toLocaleString('fr-FR');
                }
                
            } catch (error) {
                console.error('Error refreshing cache with bypass:', error);
                this.error = error.message;
            } finally {
                this.refreshing = false;
            }
        },
        
        async clearCache() {
            try {
                this.clearing = true;
                const response = await fetch('/api/debug/clear-cache', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la suppression du cache');
                }
                
                // Reload data after clearing cache
                await this.init();
            } catch (error) {
                console.error('Error clearing cache:', error);
                this.error = error.message;
            } finally {
                this.clearing = false;
            }
        },
        
        async refreshSeller(sellerName) {
            try {
                const response = await fetch('/api/debug/refresh-seller', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ seller_name: sellerName })
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de l\'actualisation du vendeur');
                }
                
                // Reload data after refreshing seller
                await this.init();
            } catch (error) {
                console.error('Error refreshing seller:', error);
                this.error = error.message;
            }
        },
        
        async refreshFactoryUdineComplete() {
            try {
                this.refreshingFactoryUdine = true;
                this.error = null;
                
                const response = await fetch('/api/debug/refresh-factoryudine-complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de l\'actualisation compl√®te de FactoryUdine');
                }
                
                // Show success message
                if (data.added_items > 0) {
                    this.error = null;
                    alert(`‚úÖ FactoryUdine mis √† jour!\n\n` +
                          `Articles pr√©c√©dents: ${data.previous_count}\n` +
                          `Nouveaux articles: ${data.new_count}\n` +
                          `Articles ajout√©s: ${data.added_items}`);
                } else {
                    alert(`‚ÑπÔ∏è Aucun nouvel article trouv√© pour FactoryUdine\n\n` +
                          `Total: ${data.count} articles`);
                }
                
                // Reload data after refreshing
                await this.init();
                
                // Auto-load debug data to show the results
                await this.loadFactoryUdineDebug();
            } catch (error) {
                console.error('Error refreshing FactoryUdine complete:', error);
                this.error = error.message;
            } finally {
                this.refreshingFactoryUdine = false;
            }
        },
        
        async loadFactoryUdineDebug() {
            try {
                this.loadingFactoryUdineDebug = true;
                this.error = null;
                
                const response = await fetch('/api/debug/factoryudine-debug', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors du chargement des donn√©es de debug');
                }
                
                this.factoryUdineDebug = data;
            } catch (error) {
                console.error('Error loading FactoryUdine debug:', error);
                this.error = error.message;
            } finally {
                this.loadingFactoryUdineDebug = false;
            }
        },
        
        async clearFactoryUdineCache() {
            try {
                this.clearingFactoryUdine = true;
                this.error = null;
                
                const response = await fetch('/api/debug/clear-factoryudine-cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la suppression du cache');
                }
                
                alert(`‚úÖ Cache FactoryUdine vid√©!\n\n` +
                      `Le cache a √©t√© supprim√©. Vous pouvez maintenant:\n` +
                      `1. Cliquer sur "Liste compl√®te" pour recharger avec le nouveau tri\n` +
                      `2. Ou cliquer sur "Charger les donn√©es de debug" pour voir les donn√©es`);
                
                // Clear debug data
                this.factoryUdineDebug = null;
                
            } catch (error) {
                console.error('Error clearing FactoryUdine cache:', error);
                this.error = error.message;
            } finally {
                this.clearingFactoryUdine = false;
            }
        },
        
        async loadJobStatus() {
            try {
                const response = await fetch('/api/debug/job-status');
                const data = await response.json();
                
                if (response.ok) {
                    this.jobStatus = data;
                    
                    // Format last job run time
                    if (data.last_run && Object.keys(data.last_run).length > 0) {
                        const lastRun = Object.values(data.last_run).sort().pop();
                        this.lastJobRun = new Date(lastRun).toLocaleString('fr-FR');
                    }
                }
            } catch (error) {
                console.error('Error loading job status:', error);
            }
        },
        
        async triggerJob(jobType) {
            try {
                const response = await fetch('/api/debug/trigger-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ job_type: jobType })
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors du d√©clenchement de la t√¢che');
                }
                
                // Show success message
                alert(`T√¢che ${jobType} d√©clench√©e avec succ√®s!`);
                
                // Reload job status
                await this.loadJobStatus();
            } catch (error) {
                console.error('Error triggering job:', error);
                this.error = error.message;
            }
        }
    }
}
</script>
{% endblock %}

