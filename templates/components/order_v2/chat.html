<!-- Replace your templates/components/order_v2/chat.html with this fixed version: -->

<!-- Chat Component - Should be integrated with orderApp() -->
<div class="space-y-6">

    <!-- Embedded Chat (visible during validation/ordered/delivered/closed stages) -->
    <div x-show="['validation','ordered','delivered','closed'].includes(order.status)" class="bg-white rounded-lg shadow mt-6">
        <div class="bg-blue-600 text-white p-4 rounded-t-lg">
            <h3 class="font-semibold">ðŸ’¬ Discussion de la commande</h3>
        </div>
        <div class="max-h-96 overflow-y-auto p-4 space-y-4" x-ref="embeddedChatMessages">
            <template x-for="message in chatMessages" :key="message.id">
                <div class="max-w-xs p-3 rounded-lg" :class="message.is_own ? 'bg-blue-100 ml-auto' : 'bg-gray-100'">
                    <div class="font-semibold text-sm">
                        <a x-show="message.mutual_order_username && !message.is_own" 
                           :href="'/@' + message.mutual_order_username" 
                           class="text-blue-600 hover:text-blue-800 hover:underline" 
                           x-text="message.username"></a>
                        <span x-show="!message.mutual_order_username || message.is_own" 
                              x-text="message.username"></span>
                    </div>
                    <div class="text-sm" x-text="message.content"></div>
                    <div class="text-xs text-gray-500 mt-1" x-text="message.timestamp"></div>
                </div>
            </template>
            <div x-show="chatMessages.length === 0" class="text-center text-gray-500 py-8">
                Aucun message pour le moment. Soyez le premier Ã  Ã©crire !
            </div>
        </div>

        <!-- Send message input for embedded chat -->
        <div class="border-t p-4 flex space-x-2">
            <input x-model="newMessage" @keydown.enter="sendMessage()" 
                   type="text" placeholder="Votre message..." maxlength="500"
                   class="flex-1 px-3 py-2 border rounded-full focus:ring-2 focus:ring-blue-500">
            <button @click="sendMessage()" class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700">
                ðŸ“¤
            </button>
        </div>
    </div>

    <!-- Floating Chat Modal Panel (used when clicking Chat button) -->
    <div x-show="showChat" x-cloak class="fixed inset-0 bg-black bg-opacity-50 z-50" @click="toggleChat()">
        <div @click.stop="" class="fixed right-4 top-4 bottom-4 w-96 bg-white rounded-lg shadow-xl flex flex-col">
            <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold">ðŸ’¬ Discussion</h3>
                        <p class="text-sm opacity-90" x-text="'Commande ' + order.seller_name"></p>
                    </div>
                    <button @click="toggleChat()" class="text-white hover:text-gray-200">âœ•</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4" x-ref="chatMessages">
                <template x-for="message in chatMessages" :key="message.id">
                    <div class="max-w-xs p-3 rounded-lg"
                         :class="message.is_own ? 'bg-blue-100 ml-auto' : 'bg-gray-100'">
                        <div class="font-semibold text-sm">
                            <a x-show="message.mutual_order_username && !message.is_own" 
                               :href="'/@' + message.mutual_order_username" 
                               class="text-blue-600 hover:text-blue-800 hover:underline" 
                               x-text="message.username"></a>
                            <span x-show="!message.mutual_order_username || message.is_own" 
                                  x-text="message.username"></span>
                        </div>
                        <div class="text-sm" x-text="message.content"></div>
                        <div class="text-xs text-gray-500 mt-1" x-text="message.timestamp"></div>
                    </div>
                </template>
                <div x-show="chatMessages.length === 0" class="text-center text-gray-500 py-8">
                    Aucun message pour le moment. Soyez le premier Ã  Ã©crire !
                </div>
            </div>
            <div class="border-t p-4 flex space-x-2">
                <input x-model="newMessage" @keydown.enter="sendMessage()" 
                       type="text" placeholder="Votre message..." maxlength="500"
                       class="flex-1 px-3 py-2 border rounded-full focus:ring-2 focus:ring-blue-500">
                <button @click="sendMessage()" class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700">
                    ðŸ“¤
                </button>
            </div>
        </div>
    </div>

</div>