<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commande {{ order.seller_name }} - MUTUAL ORDER</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-50">
    <div x-data="orderApp()" x-init="init()" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-xl font-bold text-blue-600 hover:text-blue-800">MUTUAL ORDER 0.4</a>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-700">{{ current_user.username }}</span>
                    <a href="/logout" class="text-blue-600 hover:text-blue-800">D√©connexion</a>
                </div>
            </div>
        </header>

        <div x-show="loading" x-cloak class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>

        <div x-show="!loading" x-cloak class="max-w-7xl mx-auto px-4 py-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                <!-- Main Content - 2/3 width -->
                <div class="lg:col-span-2">
                    
                    <!-- Flash Messages -->
                    <div x-show="flashMessage" x-cloak 
                         class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6">
                        <span x-text="flashMessage"></span>
                    </div>

                    <!-- Combined Seller Info and Stats -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <!-- Header line with seller info and actions -->
                        <div class="flex items-baseline space-x-4 mb-3">
                            <h1 class="text-2xl font-bold text-gray-900" x-text="'Commande chez ' + order.seller_name"></h1>
                            
                            <div x-show="sellerInfo.rating" class="flex items-center space-x-1 bg-gray-100 px-2 py-1 rounded-full">
                                <span class="text-yellow-500">‚≠ê</span>
                                <span class="text-sm font-medium" x-text="sellerInfo.rating ? sellerInfo.rating.toFixed(0) + '%' : ''"></span>
                            </div>
                            
                            <div x-show="sellerInfo.location && sellerInfo.location !== 'Non sp√©cifi√©e'" class="flex items-center space-x-1 text-gray-600 bg-gray-100 px-2 py-1 rounded-full">
                                <span>üìç</span>
                                <span class="text-sm" x-text="sellerInfo.location"></span>
                            </div>
                            
                            <a :href="'https://www.discogs.com/user/' + order.seller_name" target="_blank" 
                            class="flex items-center space-x-1 px-3 py-1 bg-white border border-black rounded-full text-black hover:bg-gray-50 text-xs transition-colors">
                                <span>üë§</span>
                                <span>Profil Discogs</span>
                            </a>
                            
                            <a x-show="order.direct_url" :href="order.direct_url" target="_blank"
                            class="flex items-center space-x-1 px-3 py-1 bg-white border border-black rounded-full text-black hover:bg-gray-50 text-xs transition-colors">
                                <span>üîó</span>
                                <span>Site vendeur</span>
                            </a>
                        </div>

                        <!-- Main content grid -->
                        <!-- Left side: Info blocks (8 columns, 3x2 grid) -->
                        <div class="col-span-8 grid grid-cols-7 gap-2">                               
                            <!-- Number of discs -->
                            <div class="p-2 bg-gray-100 rounded text-center flex flex-col items-center justify-center min-h-[50px]">
                                <div class="flex items-center space-x-1 mb-1">
                                    <span class="text-md">üíø</span>
                                    <span class="text-lg font-bold text-gray-900" x-text="order.available_count"></span>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Disques</span>
                            </div>
                            
                            <!-- Number of participants -->
                            <div class="p-2 bg-gray-100 rounded text-center flex flex-col items-center justify-center min-h-[50px]">
                                <div class="flex items-center space-x-1 mb-1">
                                    <span class="text-sm">üë•</span>
                                    <span class="text-lg font-bold text-gray-900" x-text="order.participants_count"></span>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Participants</span>
                            </div>                            

                            <!-- Time remaining until deadline - EDITABLE -->
                            <div class="relative p-2 bg-gray-100 rounded text-center flex flex-col items-center justify-center min-h-[50px]">
                                <!-- Edit pen icon -->
                                <button x-show="order.creator_id === currentUserId || isAdmin" 
                                        @click="editField = 'deadline'"
                                        class="absolute top-1 right-1 text-xs text-gray-600 hover:text-black transition-colors">
                                    ‚úèÔ∏è
                                </button>
                                <div class="flex items-center space-x-1 mb-1">
                                    <span class="text-sm">üïí</span>
                                    <span class="text-sm font-bold text-gray-900" 
                                        x-text="order.deadline ? Math.max(0, Math.ceil((new Date(order.deadline) - new Date()) / (1000 * 60 * 60 * 24))) + 'j' : 'N/A'"></span>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Restants</span>
                            </div>
                            
                            <!-- Creator -->
                            <div class="p-2 bg-gray-100 rounded text-center flex flex-col items-center justify-center min-h-[50px]">
                                <div class="flex items-center space-x-1 mb-1">
                                    <span class="text-sm">üëë</span>
                                    <span class="text-sm font-bold text-gray-900 leading-tight" x-text="order.creator?.username"></span>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Cr√©ateur</span>
                            </div>

                            <!-- Location - EDITABLE -->
                            <div class="relative p-2 bg-gray-100 rounded text-center flex flex-col items-center justify-center min-h-[50px]">
                                <!-- Edit pen icon -->
                                <button x-show="order.creator_id === currentUserId || isAdmin" 
                                        @click="editField = 'location'"
                                        class="absolute top-1 right-1 text-xs text-gray-400 hover:text-gray-600 transition-colors">
                                    ‚úèÔ∏è
                                </button>
                                <div class="flex items-center space-x-1 mb-1">
                                    <span class="text-sm">üè†</span>
                                    <span class="text-xs font-bold text-gray-900 leading-tight" 
                                        x-text="order.user_location || 'N/A'"></span>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Localisation</span>
                            </div>

                            <!-- Payment rule - EDITABLE -->
                            <div class="relative p-2 bg-gray-100 rounded text-center flex flex-col items-center justify-center min-h-[50px]">
                                <!-- Edit pen icon -->
                                <button x-show="order.creator_id === currentUserId || isAdmin" 
                                        @click="editField = 'payment'"
                                        class="absolute top-1 right-1 text-xs text-gray-400 hover:text-gray-600 transition-colors">
                                    ‚úèÔ∏è
                                </button>
                                <div class="flex items-center space-x-1 mb-1">
                                    <span class="text-xs font-medium text-gray-900 leading-tight">üí≥ Paiement</span>
                                </div>
                                <span class="text-sm font-bold text-gray-700" x-text="order.payment_timing"></span>
                            </div>

                            <!-- PayPal Me - EDITABLE -->
                            <div class="relative p-2 rounded text-center flex flex-col items-center justify-center min-h-[50px]"
                                :class="order.paypal_link ? 'bg-blue-100 cursor-pointer hover:bg-blue-200' : 'bg-gray-100'"
                                @click="order.paypal_link && editField !== 'paypal' ? window.open(order.paypal_link, '_blank') : null">
                                <!-- Edit pen icon -->
                                <button x-show="order.creator_id === currentUserId || isAdmin" 
                                        @click.stop="editField = 'paypal'"
                                        class="absolute top-1 right-1 text-xs text-gray-400 hover:text-gray-600 transition-colors">
                                    ‚úèÔ∏è
                                </button>
                                <div class="flex items-center space-x-1 mb-1">
                                    <span class="text-sm">üí≥</span>
                                    <span class="text-sm font-bold" 
                                        :class="order.paypal_link ? 'text-blue-600' : 'text-gray-400'"
                                        x-text="order.paypal_link ? 'Actif' : 'N/A'"></span>
                                </div>
                                <span class="text-xs font-medium text-gray-700">PayPal Me</span>
                            </div>
                            
                            <!-- Discount - EDITABLE -->
                            <div class="relative p-2 bg-gray-100 rounded text-center flex flex-col items-center justify-center min-h-[50px]">
                                <!-- Edit pen icon -->
                                <button x-show="order.creator_id === currentUserId || isAdmin" 
                                        @click="editField = 'discount'"
                                        class="absolute top-1 right-1 text-xs text-gray-400 hover:text-gray-600 transition-colors">
                                    ‚úèÔ∏è
                                </button>
                                <div class="flex items-center space-x-1 mb-1">
                                    <span class="text-sm">üí∏</span>
                                    <span class="text-lg font-bold" 
                                        :class="order.discount && order.discount > 0 ? 'text-green-600' : 'text-gray-400'"
                                        x-text="order.discount && order.discount > 0 ? order.discount.toFixed(2) + '‚Ç¨' : '0‚Ç¨'"></span>
                                </div>
                                <span class="text-xs font-medium text-gray-700">Discount</span>
                            </div>
                            
                            <!-- Shipping & Taxes - spans 3 columns - EDITABLE -->
                            <div class="relative col-span-3 p-2 bg-gray-100 rounded flex items-center justify-between min-h-[50px]">
                                <!-- Edit pen icon -->
                                <button x-show="order.creator_id === currentUserId || isAdmin" 
                                        @click="editField = 'fees'"
                                        class="absolute top-1 right-1 text-xs text-gray-400 hover:text-gray-600 transition-colors">
                                    ‚úèÔ∏è
                                </button>
                                <div class="flex items-center space-x-1">
                                    <span class="text-sm">üì¶</span>
                                    <span class="text-sm font-medium text-gray-700">Frais de port + Taxes :</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-gray-900" x-text="(order.shipping_cost + order.taxes).toFixed(2) + '‚Ç¨'"></div>
                                    <div class="text-xs text-gray-500" 
                                        x-text="order.available_count > 0 ? '(' + ((order.shipping_cost + order.taxes) / order.available_count).toFixed(2) + '‚Ç¨/disque)' : ''"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Validation Phase -->
                    <div x-show="order.status === 'validation'" class="bg-white rounded-lg shadow p-6 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="flex items-center space-x-2 text-xl font-bold text-gray-900">
                                <span>‚è≥</span>
                                <span>Validation de la commande</span>
                            </h3>
                        </div>

                        <!-- User validation for participants -->
                        <div x-show="isParticipant && !isCreator" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 class="font-semibold text-blue-900 mb-3">R√©capitulatif de votre commande:</h4>
                            
                            <!-- My discs breakdown -->
                            <div class="mb-4">
                                <table class="w-full text-sm">
                                    <thead class="bg-blue-100">
                                        <tr>
                                            <th class="text-left p-2">Disque</th>
                                            <th class="text-right p-2">Prix unitaire</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="listing in myListings" :key="listing.id + '_validation'">
                                            <tr class="border-b border-blue-100">
                                                <td class="p-2" x-text="listing.title"></td>
                                                <td class="p-2 text-right" x-text="listing.price_value.toFixed(2) + '‚Ç¨'"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Summary -->
                            <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                                <div>
                                    <strong>Nombre de disques:</strong> <span x-text="order.current_user_summary.listings_count"></span>
                                </div>
                                <div>
                                    <strong>Sous-total disques:</strong> <span x-text="order.current_user_summary.subtotal.toFixed(2) + '‚Ç¨'"></span>
                                </div>
                                <div>
                                    <strong>Frais & Taxes (votre part):</strong> <span x-text="order.current_user_summary.fees_share.toFixed(2) + '‚Ç¨'"></span>
                                </div>
                                <div x-show="order.current_user_summary.discount_share > 0" class="col-span-2">
                                    <strong>Discount (votre part):</strong> <span class="text-green-600" x-text="'-' + order.current_user_summary.discount_share.toFixed(2) + '‚Ç¨'"></span>
                                </div>
                            </div>
                            
                            <div class="border-t border-blue-200 pt-3 mb-4">
                                <div class="flex justify-between items-center text-lg font-bold text-blue-900">
                                    <span>TOTAL √Ä PAYER:</span>
                                    <span x-text="order.current_user_summary.total.toFixed(2) + '‚Ç¨'"></span>
                                </div>
                                <div class="text-sm text-blue-700 mt-1">
                                    <strong>Moment du paiement:</strong> <span x-text="order.payment_timing"></span>
                                </div>
                            </div>
                            
                            <div x-show="!userValidated" class="space-y-3">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" x-model="validationAgreement" class="rounded">
                                    <span class="text-sm">Je suis d'accord avec le tableau r√©capitulatif ci-dessus</span>
                                </label>
                                <button @click="validateUserParticipation()" :disabled="!validationAgreement"
                                        class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                    ‚úÖ Je valide ma participation
                                </button>
                            </div>
                            <div x-show="userValidated" class="text-center p-3 bg-green-100 text-green-800 rounded-lg">
                                ‚úÖ Vous avez valid√© votre participation
                            </div>
                        </div>

                        <!-- Validation status for all participants -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-900 mb-3">√âtat des validations</h4>
                            <div class="space-y-2">
                                <template x-for="participant in order.participants" :key="participant.id + '_validation_status'">
                                    <div class="flex justify-between items-center">
                                        <span x-text="participant.username + (participant.is_creator ? ' üëë' : '')"></span>
                                        <span x-show="participant.is_creator" class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                                            Auto-valid√© (cr√©ateur)
                                        </span>
                                        <span x-show="!participant.is_creator && isParticipantValidated(participant.id)" 
                                              class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">
                                            ‚úÖ Valid√©
                                        </span>
                                        <span x-show="!participant.is_creator && !isParticipantValidated(participant.id)" 
                                              class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">
                                            ‚è≥ En attente
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add Listing Section (building phase only)-->
                    <div x-show="order.status === 'building'" class="bg-white rounded-lg shadow p-6 mt-6">
                        <div class="flex items-baseline space-x-4 mb-4">
                            <h3 class="flex items-center space-x-2 text-xl font-bold text-gray-900">
                                <span class="bg-yellow-100 px-3 py-1 rounded-full">
                                <span>‚ûï</span>
                                <span>Ajouter un disque</span>
                            </h3>
                            <a :href="'https://www.discogs.com/seller/' + order.seller_name + '/profile'" target="_blank"
                            class="flex items-baseline space-x-1 px-3 py-1 bg-white border border-black rounded-full text-black hover:bg-gray-50 text-xs transition-colors">
                                <span>üë§</span>
                                <span>Voir les autres disques du vendeur</span>
                            </a>
                        </div>
                        <div class="flex space-x-4">
                            <input x-model="newListingUrl" type="url" 
                                placeholder="Coller l'URL de l'annonce Discogs..."
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500">
                            <button @click="addListing()" 
                                    class="px-6 py-3 bg-blue-600 text-white rounded-full hover:bg-blue-700">
                                Ajouter √† la commande
                            </button>
                        </div>
                    </div>

                    <!-- Embedded Chat Section (ordered/delivered/closed phases - before disc listings) -->
                    <div x-show="['ordered', 'delivered', 'closed'].includes(order.status)" class="bg-white rounded-lg shadow mt-6">
                        <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-semibold">üí¨ Discussion de la commande</h3>
                                    <p class="text-sm opacity-90" x-text="'Commande ' + order.seller_name"></p>
                                </div>
                                <span x-show="unreadCount > 0"
                                    class="bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">
                                    <span x-text="unreadCount > 99 ? '99+' : unreadCount"></span>
                                </span>
                            </div>
                        </div>
                        <div class="max-h-96 overflow-y-auto p-4 space-y-4" x-ref="embeddedChatMessages">
                            <template x-for="message in chatMessages.slice(-10)" :key="message.id">
                                <div class="max-w-xs p-3 rounded-lg"
                                    :class="message.is_own ? 'bg-blue-100 ml-auto' : 'bg-gray-100'">
                                    <div class="font-semibold text-sm" x-text="message.username"></div>
                                    <div class="text-sm" x-text="message.content"></div>
                                    <div class="text-xs text-gray-500 mt-1" x-text="message.timestamp"></div>
                                </div>
                            </template>
                            <div x-show="chatMessages.length === 0" class="text-center text-gray-500 py-8">
                                Aucun message pour le moment. Soyez le premier √† √©crire !
                            </div>
                        </div>
                        <div class="border-t p-4">
                            <div class="flex space-x-2">
                                <input x-model="newMessage" @keydown.enter="sendMessage()" 
                                    type="text" placeholder="Votre message..." maxlength="500"
                                    class="flex-1 px-3 py-2 border rounded-full focus:ring-2 focus:ring-blue-500">
                                <button @click="sendMessage()" 
                                        class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700">
                                    üì§
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- My Discs Section -->
                    <div x-show="myListings.length > 0" class="bg-white rounded-lg shadow p-6 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="flex items-center space-x-2 text-xl font-bold text-gray-900">
                                <span class="bg-yellow-100 px-3 py-1 rounded-full">
                                    <span>üíø</span>
                                    <span>Mes disques</span>
                                </span>
                            </h3>
                            <button x-show="order.status === 'building'" @click="verifyAvailability()"
                                    class="flex items-center space-x-1 px-3 py-1 border border-dashed border-gray-400 rounded-full text-gray-600 hover:bg-gray-50 text-xs transition-colors">
                                <span>üîÑ</span>
                                <span>V√©rifier dispo</span>
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pochette</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Titre</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prix</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">√âtat Vinyle</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">√âtat Pochette</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <template x-for="listing in myListings" :key="listing.id">
                                        <tr>
                                            <td class="px-6 py-4">
                                                <img x-show="listing.image_url" :src="listing.image_url" 
                                                     class="w-16 h-16 object-cover rounded">
                                                <div x-show="!listing.image_url" 
                                                     class="w-16 h-16 bg-gray-100 rounded flex items-center justify-center">
                                                    <span class="text-gray-400">?</span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="font-medium text-gray-900" x-text="listing.title"></div>
                                                <div class="text-sm text-gray-500" x-text="'ID: ' + listing.discogs_id"></div>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-900" x-text="listing.price_value.toFixed(2) + '‚Ç¨'"></td>
                                            <td class="px-6 py-4">
                                                <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                                      :class="getConditionClass(listing.media_condition)"
                                                      x-text="getShortCondition(listing.media_condition)"></span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                                      :class="getConditionClass(listing.sleeve_condition)"
                                                      x-text="getShortCondition(listing.sleeve_condition)"></span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex items-center space-x-2">
                                                    <a :href="listing.listing_url" target="_blank"
                                                        class="p-2 text-gray-600 rounded-full hover:bg-gray-100 transition-colors"
                                                        title="Voir sur Discogs">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                            <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                                                            <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                                                        </svg>
                                                    </a>

                                                    <button x-show="order.status === 'building'" @click="removeListing(listing.id)"
                                                        class="p-2 text-red-600 rounded-full hover:bg-red-100 transition-colors"
                                                        title="Retirer le disque">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Other Discs Section -->
                    <div x-show="otherListings.length > 0" class="bg-white rounded-lg shadow p-6 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="flex items-center space-x-2 text-xl font-bold text-gray-900">
                                <span class="bg-yellow-100 px-3 py-1 rounded-full">
                                <span>üéµ</span>
                                <span>Les autres disques dans la commande</span>
                            </h3>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pochette</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Titre</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prix</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">√âtat Vinyle</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">√âtat Pochette</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ajout√© par</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <template x-for="listing in otherListings" :key="listing.id">
                                        <tr>
                                            <td class="px-6 py-4">
                                                <img x-show="listing.image_url" :src="listing.image_url" 
                                                    class="w-16 h-16 object-cover rounded">
                                                <div x-show="!listing.image_url" 
                                                    class="w-16 h-16 bg-gray-100 rounded flex items-center justify-center">
                                                    <span class="text-gray-400">?</span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="font-medium text-gray-900" x-text="listing.title"></div>
                                                <div class="text-sm text-gray-500" x-text="'ID: ' + listing.discogs_id"></div>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-900" x-text="listing.price_value.toFixed(2) + '‚Ç¨'"></td>
                                            
                                            <td class="px-6 py-4">
                                                <div class="flex items-center">
                                                    <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                                        :class="getConditionClass(listing.media_condition)"
                                                        x-text="getShortCondition(listing.media_condition)"></span>
                                                </div>
                                            </td>
                                            
                                            <td class="px-6 py-4">
                                                <div class="flex items-center">
                                                    <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                                        :class="getConditionClass(listing.sleeve_condition)"
                                                        x-text="getShortCondition(listing.sleeve_condition)"></span>
                                                </div>
                                            </td>
                                            
                                            <td class="px-2 py-2 text-sm text-gray-900" x-text="listing.username">  </td> 

                                            <td class="px-6 py-4">
                                                <div class="flex items-center space-x-2">
                                                    <a :href="listing.listing_url" target="_blank"
                                                    class="p-2 text-gray-600 rounded-full hover:bg-gray-100 transition-colors"
                                                    title="Voir sur Discogs">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                            <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                                                            <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                                                        </svg>
                                                    </a>
                                                    <button x-show="order.status === 'building' && (listing.user_id === currentUserId || order.creator_id === currentUserId || isAdmin)" 
                                                            @click="removeListing(listing.id)"
                                                            class="p-2 text-red-600 rounded-full hover:bg-red-100 transition-colors"
                                                            title="Retirer le disque">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Embedded Chat Section (validation phase - after disc listings) -->
                    <div x-show="order.status === 'validation'" class="bg-white rounded-lg shadow mt-6">
                        <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-semibold">üí¨ Discussion de la commande</h3>
                                    <p class="text-sm opacity-90" x-text="'Commande ' + order.seller_name"></p>
                                </div>
                                <span x-show="unreadCount > 0"
                                    class="bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">
                                    <span x-text="unreadCount > 99 ? '99+' : unreadCount"></span>
                                </span>
                            </div>
                        </div>
                        <div class="max-h-96 overflow-y-auto p-4 space-y-4" x-ref="embeddedChatMessages">
                            <template x-for="message in chatMessages.slice(-10)" :key="message.id">
                                <div class="max-w-xs p-3 rounded-lg"
                                    :class="message.is_own ? 'bg-blue-100 ml-auto' : 'bg-gray-100'">
                                    <div class="font-semibold text-sm" x-text="message.username"></div>
                                    <div class="text-sm" x-text="message.content"></div>
                                    <div class="text-xs text-gray-500 mt-1" x-text="message.timestamp"></div>
                                </div>
                            </template>
                            <div x-show="chatMessages.length === 0" class="text-center text-gray-500 py-8">
                                Aucun message pour le moment. Soyez le premier √† √©crire !
                            </div>
                        </div>
                        <div class="border-t p-4">
                            <div class="flex space-x-2">
                                <input x-model="newMessage" @keydown.enter="sendMessage()" 
                                    type="text" placeholder="Votre message..." maxlength="500"
                                    class="flex-1 px-3 py-2 border rounded-full focus:ring-2 focus:ring-blue-500">
                                <button @click="sendMessage()" 
                                        class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700">
                                    üì§
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel - 1/3 width -->
                <div class="space-y-6">
                    <!-- Order Status and Share -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">√âtat de la commande</h3>
                            <button @click="shareOrder()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 text-sm transition-colors">
                                üîó Partager
                            </button>
                        </div>
                        
                        <!-- Status Progress Steps -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center relative py-2">
                                <div class="absolute inset-x-0 top-1/2 h-0.5 bg-gray-300 transform -translate-y-1/2"></div>
                                
                                <template x-for="(step, index) in statusSteps" :key="step.key">
                                    <div class="flex flex-col items-center relative z-10 gap-y-2">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mb-2"
                                            :class="getStepClass(step.key, index)">
                                            <span x-show="isStepCompleted(step.key)" class="text-white">‚úì</span>
                                            <span x-show="!isStepCompleted(step.key)" x-text="index + 1"></span>
                                        </div>
                                        <div class="text-xs text-center leading-tight max-w-16"
                                            :class="{ 'font-bold text-blue-500': step.key === order.status }" 
                                            x-text="step.emoji">
                                        </div>
                                        <div class="text-xs text-center leading-tight max-w-16"
                                            :class="{ 'font-bold text-blue-500': step.key === order.status }"
                                            x-text="step.label">
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Workflow Actions (Creator Only) -->
                        <div x-show="order.creator_id === currentUserId || isAdmin" class="space-y-1">
                            <div class="flex space-x-2 items-stretch">
                                <!-- Previous Step Button - 25% width -->
                                <button x-show="order.status !== 'building'" @click="updateOrderStatus(getPreviousStatus())"
                                        class="w-1/4 bg-gray-500 text-white py-3 px-2 rounded hover:bg-gray-600 text-sm min-h-[44px] flex items-center justify-center">
                                    <span class="leading-tight text-center">‚Üê Retour</span>
                                </button>
                                
                                <!-- Next Step Button - 75% width -->
                                <div x-show="order.status === 'building'" class="w-3/4">
                                    <button @click="updateOrderStatus('validation')"
                                            class="w-full bg-green-600 text-white py-3 px-4 rounded hover:bg-green-700 text-sm min-h-[44px] flex items-center justify-center">
                                        <span class="leading-tight text-center">√âtape suivante: ‚è≥ Validation</span>
                                    </button>
                                </div>
                                <div x-show="order.status === 'validation'" class="w-3/4">
                                    <button @click="updateOrderStatus('ordered')"
                                            class="w-full bg-blue-600 text-white py-3 px-4 rounded hover:bg-blue-700 text-sm min-h-[44px] flex items-center justify-center">
                                        <span class="leading-tight text-center">√âtape suivante: ‚úÖ Command√©</span>
                                    </button>
                                </div>
                                <div x-show="order.status === 'ordered'" class="w-3/4">
                                    <button @click="updateOrderStatus('delivered')"
                                            class="w-full bg-green-600 text-white py-3 px-4 rounded hover:bg-blue-700 text-sm min-h-[44px] flex items-center justify-center">
                                        <span class="leading-tight text-center">√âtape suivante: üíø Livr√©</span>
                                    </button>
                                </div>
                                <div x-show="order.status === 'delivered'" class="w-3/4">
                                    <button @click="updateOrderStatus('closed')"
                                            class="w-full bg-gray-600 text-white py-3 px-4 rounded hover:bg-gray-700 text-sm min-h-[44px] flex items-center justify-center">
                                        <span class="leading-tight text-center">√âtape suivante: üéÅ Distribu√©</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Participants -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <span>üë•</span>
                                <h3 class="text-lg font-semibold" x-text="'Participants (' + order.participants_count + ')'"></h3>
                            </div>
                            <button  x-show="order.status === 'building'" @click="toggleChat()"
                                class="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 text-base transition-colors">
                                <span>üí¨</span>
                                <span>Chat</span>
                                <span x-show="unreadCount > 0"
                                    class="ml-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                    <span x-text="unreadCount > 99 ? '99+' : unreadCount"></span>
                                </span>
                            </button>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <template x-for="participant in order.participants" :key="participant.id">
                                <div class="px-3 py-1 rounded-full text-sm flex items-center"
                                    :class="participant.is_creator ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'">
                                    <span x-text="participant.username"></span>
                                    <span x-show="participant.is_creator" class="ml-1">üëë</span>
                                </div>
                            </template>
                        </div>
                        </div>

                    <!-- My Order Summary -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold">Ma commande</h3>
                        <div class="space-y-3  mb-4">
                            <div class="flex justify-between">
                                <span>Nombre de disques</span>
                                <span class="font-semibold" x-text="order.current_user_summary ? order.current_user_summary.listings_count : 0"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Montant</span>
                                <span class="font-semibold" x-text="order.current_user_summary ? order.current_user_summary.subtotal.toFixed(2) + '‚Ç¨' : '0‚Ç¨'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Ma part Frais & Taxes</span>
                                <span class="font-semibold" x-text="order.current_user_summary ? order.current_user_summary.fees_share.toFixed(2) + '‚Ç¨' : '0‚Ç¨'"></span>
                            </div>
                            <div x-show="order.current_user_summary && order.current_user_summary.discount_share > 0" class="flex justify-between">
                                <span>Ma part Discount</span>
                                <span class="font-semibold text-green-600" x-text="order.current_user_summary ? '-' + order.current_user_summary.discount_share.toFixed(2) + '‚Ç¨' : '0‚Ç¨'"></span>
                            </div>
                            <div x-show="order.current_user_summary && order.current_user_summary.listings_count > 0" class="text-right">
                                <span class="text-sm text-gray-500 italic" 
                                      x-text="order.current_user_summary ? '(Soit ' + ((order.current_user_summary.fees_share - order.current_user_summary.discount_share) / order.current_user_summary.listings_count).toFixed(2) + '‚Ç¨ de frais par disque)' : ''"></span>
                            </div>
                            <hr class="my-3">
                            <div class="flex justify-between font-bold text-lg">
                                <span>Total</span>
                                <span x-text="order.current_user_summary ? order.current_user_summary.total.toFixed(2) + '‚Ç¨' : '0‚Ç¨'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Administration Section (Creator/Admin Only) -->
                    <div x-show="order.creator_id === currentUserId || isAdmin" class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold  mb-4">Administration Commande</h3>
                        
                        <!-- Settings Form -->
                        <form @submit.prevent="updateOrderSettings()" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Frais de port (‚Ç¨)</label>
                                <input type="number" x-model="adminForm.shipping_cost" 
                                       step="0.01" min="0" 
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Taxes (‚Ç¨)</label>
                                <input type="number" x-model="adminForm.taxes" 
                                       step="0.01" min="0" 
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Discount (‚Ç¨)</label>
                                <input type="number" x-model="adminForm.discount" 
                                       step="0.01" min="0" 
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Expandable section -->
                            <div class="space-y-3">
                                <button type="button" @click="showMoreSettings = !showMoreSettings"
                                        class="w-full bg-gray-100 text-gray-700 text-sm py-2 px-4 rounded hover:bg-gray-200">
                                    <span x-show="!showMoreSettings">‚ûï Modifier plus</span>
                                    <span x-show="showMoreSettings">‚ûñ R√©duire</span>
                                </button>
                                
                                <div x-show="showMoreSettings" x-cloak class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">R√®gle de paiement</label>
                                        <select x-model="adminForm.payment_timing" 
                                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                            <option value="avant la commande">Avant la commande</option>
                                            <option value="√† la remise des disques">√Ä la remise des disques</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">URL directe de la commande</label>
                                        <input type="url" x-model="adminForm.direct_url" 
                                               placeholder="https://..." 
                                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                        <div class="text-xs text-gray-500 mt-1">Lien direct vers la page de commande chez le vendeur</div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Date limite</label>
                                        <input type="date" x-model="adminForm.deadline" 
                                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Montant maximum (‚Ç¨)</label>
                                        <input type="number" x-model="adminForm.max_amount" 
                                               step="0.01" min="0" 
                                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col space-y-1">
                                <button type="submit" 
                                        class="w-full bg-green-50 text-green-600 text-sm py-2 px-4 rounded hover:bg-green-100 mb-2">
                                    Mettre √† jour
                                </button>
                            </form>
                                <!-- Delete Order Button -->
                                <button @click="deleteOrder()" 
                                        class="w-full bg-red-500 text-white text-sm py-2 px-4 rounded hover:bg-red-700 mb-2">
                                    üóëÔ∏è Supprimer la commande
                                </button>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div x-show="showChat" x-cloak class="fixed inset-0 bg-black bg-opacity-50 z-50" @click="toggleChat()">
            <div @click.stop="" class="fixed right-4 top-4 bottom-4 w-96 bg-white rounded-lg shadow-xl flex flex-col">
                <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold">üí¨ Discussion</h3>
                            <p class="text-sm opacity-90" x-text="'Commande ' + order.seller_name"></p>
                        </div>
                        <button @click="toggleChat()" class="text-white hover:text-gray-200">‚úï</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-4" x-ref="chatMessages">
                    <template x-for="message in chatMessages" :key="message.id">
                        <div class="max-w-xs p-3 rounded-lg"
                             :class="message.is_own ? 'bg-blue-100 ml-auto' : 'bg-gray-100'">
                            <div class="font-semibold text-sm" x-text="message.username"></div>
                            <div class="text-sm" x-text="message.content"></div>
                            <div class="text-xs text-gray-500 mt-1" x-text="message.timestamp"></div>
                        </div>
                    </template>
                </div>
                <div class="border-t p-4">
                    <div class="flex space-x-2">
                        <input x-model="newMessage" @keydown.enter="sendMessage()" 
                               type="text" placeholder="Votre message..." maxlength="500"
                               class="flex-1 px-3 py-2 border rounded-full focus:ring-2 focus:ring-blue-500">
                        <button @click="sendMessage()" 
                                class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700">
                            üì§
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Edit Modals -->
        <div x-show="editField" x-cloak class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" @click="editField = null">
            <div @click.stop="" class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-bold mb-4">Modification rapide</h3>
                
                <!-- Edit different fields based on editField value -->
                <div x-show="editField === 'deadline'">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date limite</label>
                    <input type="date" x-model="adminForm.deadline" class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div x-show="editField === 'location'">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Localisation</label>
                    <input type="text" x-model="adminForm.user_location" class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <!-- Add more fields as needed -->
                
                <div class="flex space-x-3 mt-6">
                    <button @click="editField = null" class="px-4 py-2 text-gray-600 border rounded-lg">Annuler</button>
                    <button @click="updateOrderSettings(); editField = null" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function orderApp() {
            return {
                loading: true,
                order: {},
                sellerInfo: {},
                myListings: [],
                otherListings: [],
                newListingUrl: '',
                flashMessage: '',
                showChat: false,
                chatMessages: [],
                newMessage: '',
                unreadCount: 0,
                currentUserId: {{ current_user.id }},
                isAdmin: {{ 'true' if current_user.is_admin else 'false' }},
                validationAgreement: false,
                userValidated: false,
                validations: [],
                showMoreSettings: false,
                editField: null,
                statusSteps: [
                    { key: 'building', label: 'Composition', emoji: '‚õèÔ∏è' },
                    { key: 'validation', label: 'Validation', emoji: '‚è≥' },
                    { key: 'ordered', label: 'Command√©', emoji: '‚úÖ' },
                    { key: 'delivered', label: 'Livr√©', emoji: 'üíø' },
                    { key: 'closed', label: 'Distribu√©', emoji: 'üéÅ' }
                ],
                adminForm: {
                    direct_url: '',
                    max_amount: '',
                    deadline: '',
                    payment_timing: 'avant la commande',
                    shipping_cost: 0,
                    taxes: 0,
                    discount: 0,
                    user_location: '',
                    paypal_link: '' 
                },
                
                async init() {
                    await this.loadOrder();
                    await this.loadSellerInfo();
                    await this.loadValidations();
                    this.initAdminForm();
                    this.checkUnreadMessages();
                    
                    // Auto-load chat messages for embedded chat (non-building phases)
                    if (this.order.status !== 'building') {
                        this.loadChatMessages();
                    }
                    
                    setInterval(() => this.checkUnreadMessages(), 30000);
                    this.loading = false;
                },
                
                async loadValidations() {
                    try {
                        // Check if current user has validated
                        const response = await fetch(`/api/orders/${this.getOrderId()}/validation-status`);
                        if (response.ok) {
                            const data = await response.json();
                            this.userValidated = data.user_validated;
                            this.validations = data.all_validations || [];
                        }
                    } catch (error) {
                        console.error('Error loading validations:', error);
                    }
                },
                
                async loadOrder() {
                    try {
                        const response = await fetch(`/api/orders/${this.getOrderId()}`);
                        if (response.ok) {
                            this.order = await response.json();
                            this.updateListings();
                        }
                    } catch (error) {
                        console.error('Error loading order:', error);
                    }
                },
                
                async loadSellerInfo() {
                    try {
                        console.log('Fetching seller info for:', this.order.seller_name);
                        const response = await fetch(`/api/sellers/${this.order.seller_name}`);
                        if (response.ok) {
                            this.sellerInfo = await response.json();
                            console.log('Seller info received:', this.sellerInfo);
                        }
                    } catch (error) {
                        console.error('Error loading seller info:', error);
                        this.sellerInfo = {
                            rating: null,
                            location: "Non sp√©cifi√©e"
                        };
                    }
                },
                
                updateListings() {
                    this.myListings = this.order.listings?.filter(l => l.user_id === this.currentUserId) || [];
                    this.otherListings = this.order.listings?.filter(l => l.user_id !== this.currentUserId) || [];
                },
                
                initAdminForm() {
                    this.adminForm = {
                        direct_url: this.order.direct_url || '',
                        max_amount: this.order.max_amount || '',
                        deadline: this.order.deadline ? this.order.deadline.split('T')[0] : '',
                        payment_timing: this.order.payment_timing || 'avant la commande',
                        shipping_cost: this.order.shipping_cost || 0,
                        taxes: this.order.taxes || 0,
                        discount: this.order.discount || 0,
                        user_location: this.order.user_location || '',
                        paypal_link: this.order.paypal_link || '' 
                    };
                },
                
                async addListing() {
                    if (!this.newListingUrl.trim()) return;
                    
                    try {
                        const response = await fetch(`/api/orders/${this.getOrderId()}/listings`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                listing_url: this.newListingUrl
                            })
                        });
                        
                        const result = await response.json();
                        if (response.ok) {
                            this.flashMessage = 'Annonce ajout√©e avec succ√®s !';
                            this.newListingUrl = '';
                            await this.loadOrder();
                            setTimeout(() => this.flashMessage = '', 3000);
                        } else {
                            alert(result.error || 'Erreur lors de l\'ajout');
                        }
                    } catch (error) {
                        console.error('Error adding listing:', error);
                        alert('Erreur lors de l\'ajout');
                    }
                },
                
                async removeListing(listingId) {
                    if (!confirm('Retirer ce disque de la commande ?')) return;
                    
                    try {
                        const response = await fetch(`/api/listings/${listingId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            this.flashMessage = 'Disque retir√© de la commande';
                            await this.loadOrder();
                            setTimeout(() => this.flashMessage = '', 3000);
                        }
                    } catch (error) {
                        console.error('Error removing listing:', error);
                    }
                },
                
                async verifyAvailability() {
                    if (!confirm('V√©rifier la disponibilit√© de tous les disques ?')) return;
                    
                    try {
                        const response = await fetch(`/api/orders/${this.getOrderId()}/verify`, {
                            method: 'POST'
                        });
                        
                        const result = await response.json();
                        if (response.ok) {
                            this.flashMessage = result.message || 'V√©rification termin√©e';
                            await this.loadOrder();
                            setTimeout(() => this.flashMessage = '', 3000);
                        }
                    } catch (error) {
                        console.error('Error verifying availability:', error);
                    }
                },
                
                async updateOrderStatus(newStatus) {
                    if (!confirm('Changer le statut de la commande ?')) return;
                    
                    try {
                        const response = await fetch(`/api/orders/${this.getOrderId()}/status`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                status: newStatus
                            })
                        });
                        
                        const result = await response.json();
                        if (response.ok) {
                            this.flashMessage = 'Statut mis √† jour avec succ√®s';
                            await this.loadOrder();
                            setTimeout(() => this.flashMessage = '', 3000);
                        } else {
                            alert(result.error || 'Erreur lors de la mise √† jour');
                        }
                    } catch (error) {
                        console.error('Error updating status:', error);
                    }
                },
                
                async updateOrderSettings() {
                    try {
                        const response = await fetch(`/api/orders/${this.getOrderId()}/settings`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.adminForm)
                        });
                        
                        const result = await response.json();
                        if (response.ok) {
                            this.flashMessage = result.message || 'Param√®tres mis √† jour avec succ√®s';
                            await this.loadOrder();
                            setTimeout(() => this.flashMessage = '', 3000);
                        } else {
                            alert(result.error || 'Erreur lors de la mise √† jour');
                        }
                    } catch (error) {
                        console.error('Error updating settings:', error);
                        alert('Erreur lors de la mise √† jour');
                    }
                },
                
                async deleteOrder() {
                    if (!confirm('ATTENTION: Supprimer d√©finitivement cette commande et tous ses disques ? Cette action est irr√©versible.')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/orders/${this.getOrderId()}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        if (response.ok) {
                            alert('Commande supprim√©e avec succ√®s');
                            window.location.href = '/';
                        } else {
                            alert(result.error || 'Erreur lors de la suppression');
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        alert('Erreur lors de la suppression');
                    }
                },
                
                toggleChat() {
                    this.showChat = !this.showChat;
                    if (this.showChat) {
                        this.loadChatMessages();
                        this.markMessagesAsRead();
                    }
                },
                
                async loadChatMessages() {
                    try {
                        const response = await fetch(`/api/orders/${this.getOrderId()}/chat/messages`);
                        if (response.ok) {
                            this.chatMessages = await response.json();
                            setTimeout(() => {
                                if (this.$refs.chatMessages) {
                                    this.$refs.chatMessages.scrollTop = this.$refs.chatMessages.scrollHeight;
                                }
                            }, 100);
                        }
                    } catch (error) {
                        console.error('Error loading chat messages:', error);
                    }
                },
                
                async sendMessage() {
                    if (!this.newMessage.trim()) return;
                    
                    try {
                        const response = await fetch(`/api/orders/${this.getOrderId()}/chat/send`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                message: this.newMessage
                            })
                        });
                        
                        if (response.ok) {
                            this.newMessage = '';
                            await this.loadChatMessages();
                        }
                    } catch (error) {
                        console.error('Error sending message:', error);
                    }
                },
                
                async checkUnreadMessages() {
                    if (this.showChat) return;
                    
                    try {
                        const response = await fetch(`/api/orders/${this.getOrderId()}/chat/unread`);
                        if (response.ok) {
                            const data = await response.json();
                            this.unreadCount = data.unread_count;
                        }
                    } catch (error) {
                        console.error('Error checking unread messages:', error);
                    }
                },
                
                async markMessagesAsRead() {
                    try {
                        await fetch(`/api/orders/${this.getOrderId()}/chat/mark_read`, {
                            method: 'POST'
                        });
                        this.unreadCount = 0;
                    } catch (error) {
                        console.error('Error marking messages as read:', error);
                    }
                },
                
                shareOrder() {
                    const url = window.location.href;
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(url).then(function() {
                            alert('Lien copi√© dans le presse-papiers !');
                        });
                    } else {
                        const textArea = document.createElement("textarea");
                        textArea.value = url;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('Lien copi√© dans le presse-papiers !');
                    }
                },
                
                getConditionClass(condition) {
                    if (condition.includes('Mint')) return 'bg-green-100 text-green-800';
                    if (condition.includes('Near Mint')) return 'bg-emerald-100 text-emerald-800';
                    if (condition.includes('Very Good Plus')) return 'bg-yellow-100 text-yellow-800';
                    if (condition.includes('Very Good')) return 'bg-orange-100 text-orange-800';
                    if (condition.includes('Good')) return 'bg-red-100 text-red-800';
                    return 'bg-gray-100 text-gray-800';
                },
                
                getShortCondition(condition) {
                    if (!condition) return '';
                    // Extract first word and plus/minus if present (e.g. "Very Good Plus (VG+)" => "VG+")
                    const match = condition.match(/\(([^)]+)\)/);
                    if (match) return match[1];
                    // Fallback: try to extract known codes
                    if (condition.includes('Mint')) return 'M';
                    if (condition.includes('Near Mint')) return 'NM';
                    if (condition.includes('Very Good Plus')) return 'VG+';
                    if (condition.includes('Very Good')) return 'VG';
                    if (condition.includes('Good Plus')) return 'G+';
                    if (condition.includes('Good')) return 'G';
                    if (condition.includes('Fair')) return 'F';
                    if (condition.includes('Poor')) return 'P';
                    return condition;
                },
                
                getTimeRemaining(deadline) {
                    if (!deadline) return '';
                    const now = new Date();
                    const end = new Date(deadline);
                    const diff = end - now;

                    if (diff <= 0) return 'Expir√©';

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

                    if (days > 0) return `${days}j ${hours}h`;
                    if (hours > 0) return `${hours}h`;
                    return '<1h';
                },
                
                formatDate(dateString) {
                    if (!dateString) return '';
                    return new Date(dateString).toLocaleDateString('fr-FR', {
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit'
                    });
                },
                
                getStepClass(stepKey, index) {
                    const currentIndex = this.statusSteps.findIndex(step => step.key === this.order.status);
                    if (index < currentIndex) {
                        return 'bg-green-500 text-white'; // Completed
                    } else if (index === currentIndex) {
                        return 'bg-blue-500 text-white'; // Current
                    } else {
                        return 'bg-gray-200 text-gray-600'; // Pending
                    }
                },
                
                isStepCompleted(stepKey) {
                    const currentIndex = this.statusSteps.findIndex(step => step.key === this.order.status);
                    const stepIndex = this.statusSteps.findIndex(step => step.key === stepKey);
                    return stepIndex < currentIndex;
                },
                
                getPreviousStatus() {
                    const statusOrder = ['building', 'validation', 'ordered', 'delivered', 'closed'];
                    const currentIndex = statusOrder.indexOf(this.order.status);
                    return currentIndex > 0 ? statusOrder[currentIndex - 1] : 'building';
                },

                getOrderId() {
                    return window.location.pathname.split('/')[2];
                },
                
                // Simplified getters using backend calculations
                get myTotal() {
                    return this.order.current_user_summary ? this.order.current_user_summary.subtotal : 0;
                },
                
                get myFeesShare() {
                    return this.order.current_user_summary ? this.order.current_user_summary.fees_share : 0;
                },

                get myDiscountShare() {
                    return this.order.current_user_summary ? this.order.current_user_summary.discount_share : 0;
                },

                get isCreator() {
                    return this.order.creator_id === this.currentUserId;
                },

                get isParticipant() {
                    return this.myListings.length > 0;
                },

                async validateUserParticipation() {
                    if (!this.validationAgreement) return;

                    try {
                        const response = await fetch(`/api/orders/${this.getOrderId()}/validate`, {
                            method: 'POST'
                        });

                        const result = await response.json();
                        if (response.ok) {
                            this.userValidated = true;
                            this.flashMessage = 'Participation valid√©e avec succ√®s';
                            await this.loadValidations(); // Refresh validation data
                            await this.loadOrder(); // Refresh order data
                            setTimeout(() => this.flashMessage = '', 3000);
                        } else {
                            alert(result.error || 'Erreur lors de la validation');
                        }
                    } catch (error) {
                        console.error('Error validating participation:', error);
                        alert('Erreur lors de la validation');
                    }
                },

                isParticipantValidated(participantId) {
                    return this.validations.some(v => v.user_id === participantId && v.validated);
                },

                quickEdit(field, value) {
                    const updates = {};
                    updates[field] = value;
                    
                    fetch(`/api/orders/${this.getOrderId()}/settings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updates)
                    }).then(response => {
                        if (response.ok) {
                            this.editField = null;
                            this.loadOrder();
                            this.flashMessage = 'Mis √† jour avec succ√®s';
                            setTimeout(() => this.flashMessage = '', 3000);
                        } else {
                            this.flashMessage = 'Erreur lors de la mise √† jour';
                            setTimeout(() => this.flashMessage = '', 3000);
                        }
                    }).catch(error => {
                        console.error('Error updating field:', error);
                        this.flashMessage = 'Erreur de connexion';
                        setTimeout(() => this.flashMessage = '', 3000);
                    });
                }
            }
        }
    </script>
</body>
</html>